From 4c36417b875e65efbe2d5c1f0456f377f1c76da9 Mon Sep 17 00:00:00 2001
From: Alex Wang <ice_b0und@hotmail.com>
Date: Fri, 16 Oct 2015 14:53:37 +0800
Subject: [PATCH 088/150] PAPA-128 fix 404.json

---
 app/controllers/errors_controller.rb           |  5 ++
 app/controllers/files_controller.rb            |  2 +-
 app/views/files/show.json.jbuilder             |  1 +
 app/views/lesson_comments/index.json.jbuilder  |  4 +-
 app/views/student_comments/index.json.jbuilder |  1 +
 config/application.rb                          |  3 ++
 config/environments/development.rb             |  2 +
 config/initializers/constants.rb               |  1 +
 config/routes.rb                               |  3 ++
 public/404.html                                | 67 --------------------------
 10 files changed, 19 insertions(+), 70 deletions(-)
 create mode 100644 app/controllers/errors_controller.rb
 delete mode 100644 public/404.html

diff --git a/app/controllers/errors_controller.rb b/app/controllers/errors_controller.rb
new file mode 100644
index 0000000..9d9a0f1
--- /dev/null
+++ b/app/controllers/errors_controller.rb
@@ -0,0 +1,5 @@
+class ErrorsController < ApplicationController
+  def not_found
+    json_failed(REASON_INVALID_OPERATION)
+  end
+end
\ No newline at end of file
diff --git a/app/controllers/files_controller.rb b/app/controllers/files_controller.rb
index e00a84b..29504f8 100644
--- a/app/controllers/files_controller.rb
+++ b/app/controllers/files_controller.rb
@@ -33,7 +33,7 @@ class FilesController < ApplicationController
       file.write(temp.read)
     end
 
-    @file = FileResource.create(file_type: params[:file][:type], name: temp.original_filename, path: rel_loc)
+    @file = FileResource.create(file_type: params[:file][:type], name: temp.original_filename, path: File.join('', rel_loc))
     if @file
       json_successful
     else
diff --git a/app/views/files/show.json.jbuilder b/app/views/files/show.json.jbuilder
index 1ddc3b1..bf99424 100644
--- a/app/views/files/show.json.jbuilder
+++ b/app/views/files/show.json.jbuilder
@@ -2,5 +2,6 @@ json.status STATUS_SUCCESS
 json.file do
   json.id   @file.id
   json.name @file.name
+  json.type @file.type
   json.path @file.path
 end
\ No newline at end of file
diff --git a/app/views/lesson_comments/index.json.jbuilder b/app/views/lesson_comments/index.json.jbuilder
index 8f00c9b..0ecbb88 100644
--- a/app/views/lesson_comments/index.json.jbuilder
+++ b/app/views/lesson_comments/index.json.jbuilder
@@ -2,7 +2,7 @@ json.status STATUS_SUCCESS
 json.lesson_comments do
   json.array! @lesson_comments do |lesson_comment|
     json.extract! lesson_comment, :id
-    json.exactly! lesson_comment, :content
-    json.exactly! lesson_comment, :score
+    json.extract! lesson_comment, :content
+    json.extract! lesson_comment, :score
   end
 end
\ No newline at end of file
diff --git a/app/views/student_comments/index.json.jbuilder b/app/views/student_comments/index.json.jbuilder
index 61bd932..a91b0e5 100644
--- a/app/views/student_comments/index.json.jbuilder
+++ b/app/views/student_comments/index.json.jbuilder
@@ -4,6 +4,7 @@ json.student_comments do
     json.extract! student_comment, :id
     json.extract! student_comment, :content
     json.extract! student_comment, :score
+    json.extract! student_comment, :creator_id
   end
 end
 
diff --git a/config/application.rb b/config/application.rb
index 2e9dd58..81d5ced 100644
--- a/config/application.rb
+++ b/config/application.rb
@@ -25,5 +25,8 @@ module Papdb
 
     # Do not swallow errors in after_commit/after_rollback callbacks.
     config.active_record.raise_in_transactional_callbacks = true
+
+    # redirect errors to rails.
+    config.exceptions_app = self.routes
   end
 end
diff --git a/config/environments/development.rb b/config/environments/development.rb
index 85e56c8..5a24356 100644
--- a/config/environments/development.rb
+++ b/config/environments/development.rb
@@ -41,4 +41,6 @@ Rails.application.configure do
 
   # Raises error for missing translations
   # config.action_view.raise_on_missing_translations = true
+
+  config.consider_all_requests_local = false
 end
diff --git a/config/initializers/constants.rb b/config/initializers/constants.rb
index 8600334..e7ac4d0 100644
--- a/config/initializers/constants.rb
+++ b/config/initializers/constants.rb
@@ -12,5 +12,6 @@ REASON_TOKEN_INVALID = 'token_invalid'
 REASON_TOKEN_TIMEOUT = 'token_timeout'
 REASON_TOKEN_NOT_MATCH = 'token_not_match'
 REASON_NOT_IMPLEMENTED = 'not_implemented'
+REASON_INVALID_OPERATION = 'invalid_operation'
 
 ALLOWED_FILE_SUFFIXES = [ 'jpg', 'gif', 'png', 'mp4', 'mpg', 'avi' ]
\ No newline at end of file
diff --git a/config/routes.rb b/config/routes.rb
index 26fd67d..dd63a50 100644
--- a/config/routes.rb
+++ b/config/routes.rb
@@ -1,5 +1,8 @@
 Rails.application.routes.draw do
 
+  # error handling
+  get "/404" => "errors#not_found"
+
   devise_for :users, controllers: {
     sessions: 'users/sessions',
     registrations: 'users/registrations'
diff --git a/public/404.html b/public/404.html
deleted file mode 100644
index b612547..0000000
--- a/public/404.html
+++ /dev/null
@@ -1,67 +0,0 @@
-<!DOCTYPE html>
-<html>
-<head>
-  <title>The page you were looking for doesn't exist (404)</title>
-  <meta name="viewport" content="width=device-width,initial-scale=1">
-  <style>
-  body {
-    background-color: #EFEFEF;
-    color: #2E2F30;
-    text-align: center;
-    font-family: arial, sans-serif;
-    margin: 0;
-  }
-
-  div.dialog {
-    width: 95%;
-    max-width: 33em;
-    margin: 4em auto 0;
-  }
-
-  div.dialog > div {
-    border: 1px solid #CCC;
-    border-right-color: #999;
-    border-left-color: #999;
-    border-bottom-color: #BBB;
-    border-top: #B00100 solid 4px;
-    border-top-left-radius: 9px;
-    border-top-right-radius: 9px;
-    background-color: white;
-    padding: 7px 12% 0;
-    box-shadow: 0 3px 8px rgba(50, 50, 50, 0.17);
-  }
-
-  h1 {
-    font-size: 100%;
-    color: #730E15;
-    line-height: 1.5em;
-  }
-
-  div.dialog > p {
-    margin: 0 0 1em;
-    padding: 1em;
-    background-color: #F7F7F7;
-    border: 1px solid #CCC;
-    border-right-color: #999;
-    border-left-color: #999;
-    border-bottom-color: #999;
-    border-bottom-left-radius: 4px;
-    border-bottom-right-radius: 4px;
-    border-top-color: #DADADA;
-    color: #666;
-    box-shadow: 0 3px 8px rgba(50, 50, 50, 0.17);
-  }
-  </style>
-</head>
-
-<body>
-  <!-- This file lives in public/404.html -->
-  <div class="dialog">
-    <div>
-      <h1>The page you were looking for doesn't exist.</h1>
-      <p>You may have mistyped the address or the page may have moved.</p>
-    </div>
-    <p>If you are the application owner check the logs for more information.</p>
-  </div>
-</body>
-</html>
-- 
1.9.1

