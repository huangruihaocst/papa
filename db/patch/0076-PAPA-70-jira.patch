From 0260b9e82eb669c3203e6a3954a88d999a9717a8 Mon Sep 17 00:00:00 2001
From: luogan <luogan_62625686@126.com>
Date: Thu, 15 Oct 2015 09:49:49 +0800
Subject: [PATCH 076/150] =?UTF-8?q?PAPA-70=20=E6=B7=BB=E5=8A=A0=E4=BA=86?=
 =?UTF-8?q?=E5=88=A0=E9=99=A4=E9=80=89=E8=AF=BE=E7=9A=84=E5=8A=9F=E8=83=BD?=
 =?UTF-8?q?=EF=BC=8C=E8=B7=B3=E8=BD=AC=E5=88=B0=E5=85=B6=E4=BB=96=E7=95=8C?=
 =?UTF-8?q?=E9=9D=A2=E7=9A=84=E5=8A=9F=E8=83=BD=E5=92=8C=E5=A4=A7=E9=87=8F?=
 =?UTF-8?q?=E5=92=8C=E6=95=B0=E6=8D=AE=E5=BA=93=E4=BA=A4=E4=BA=92=E7=9A=84?=
 =?UTF-8?q?=E5=8A=9F=E8=83=BD=EF=BC=88=E4=B9=8B=E5=89=8Djira=E5=B4=A9?=
 =?UTF-8?q?=E4=BA=86=EF=BC=8C=E8=BF=99=E9=87=8C=E4=B8=80=E6=AC=A1=E6=80=A7?=
 =?UTF-8?q?=E6=8F=90=E4=BA=A4=EF=BC=89?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 app/views/manage/class_info.html.erb |  38 +++++++-
 app/views/manage/main_page.html.erb  | 168 +++++++++++++++++++++++++++++++----
 2 files changed, 184 insertions(+), 22 deletions(-)

diff --git a/app/views/manage/class_info.html.erb b/app/views/manage/class_info.html.erb
index fc40293..953cfa1 100644
--- a/app/views/manage/class_info.html.erb
+++ b/app/views/manage/class_info.html.erb
@@ -45,13 +45,25 @@
 		</div>
 	</div>
 	<script>
-		var n,courseInfo,comments=new Array(),people=new Array(2),score=new Array(11);
+		var courseId,classId;
+		
+		function getId()
+		{
+			var p=window.location.href.split("/");
+			p=p[p.length-1];
+			courseId=p.split("&")[0];
+			classId=p.split("&")[1];
+		}
+		
+		var n,courseInfo,comments=new Array(),people=new Object(),score=new Array(11);
+		
 		$("#chart1")[0].height=$("#chart1")[0].width;
 		$("#chart2")[0].height=$("#chart2")[0].width;
 		var totalPages,nowPage,numberPerPage=15;
+		
 		function loadInfo()
 		{
-			people[0]=100;people[1]=10;
+			people[0].attend=100;people.absense=10;
 			for (i=0;i<11;++i) score[i]=10;
 			courseInfo="计算机组成原理";
 			var i;
@@ -64,6 +76,26 @@
 			}
 			totalPages=Math.floor((n-1)/numberPerPage+1);
 			nowPage=1;
+			$.get("/courses/"+courseId+"/students.json",{},
+			function(data)
+			{
+				people.tot=data.size();
+			});
+			$.get("/lessons/"+classId+"/students.json",{},
+			function(data)
+			{
+				people.attend=data.size();
+				people.absense=people.tot-people.attend;
+				var i;
+				for (i=0;i<data.length;++i)
+				{
+					$.get("/students/"+data[i].id+"/lessons/"+classId+".json",{},
+					function(data)
+					{
+						++score[data];
+					});
+				}
+			});
 		}
 		
 		function changePage(x)
@@ -97,7 +129,7 @@
 			data={labels:["上课人数","缺勤人数"],datasets:[{
 					fillColor : "rgba(151,187,205,0.5)",
 					strokeColor : "rgba(151,187,205,1)",
-					data : [people[0],people[1]]}]};
+					data : [people.attend,people.absense]}]};
 			data2={labels:["0分","1分","2分","3分","4分","5分","6分","7分","8分","9分","10分"],datasets:[{
 					fillColor : "rgba(151,187,205,0.5)",
 					strokeColor : "rgba(151,187,205,1)",
diff --git a/app/views/manage/main_page.html.erb b/app/views/manage/main_page.html.erb
index 016a1d7..cdb84b7 100644
--- a/app/views/manage/main_page.html.erb
+++ b/app/views/manage/main_page.html.erb
@@ -123,6 +123,12 @@
 					<input id="input-add-class-1" type="text" class="form-control"></input>
 					<h4>实验内容</h4>
 					<textarea id="input-add-class-2" type="text" class="form-control"></textarea>
+					<h4>开始时间</h4>
+					<input id="input-add-class-3" type="text" class="form-control" placeholder="2000-01-01 20:00"></input>    <!--#modify-->
+					<h4>结束时间</h4>
+					<input id="input-add-class-4" type="text" class="form-control" placeholder="2000-01-01 20:00"></input>    <!--#modify-->
+					<h4>实验地点</h4>
+					<input id="input-add-class-5" type="text" class="form-control"></input>
 				</div>
 				<div class="modal-footer">
 					<button class="btn btn-primary" onclick="confirmClass()" data-dismiss="modal">添加</button>
@@ -144,6 +150,12 @@
 					<input id="input-modify-class-1" type="text" class="form-control"></input>
 					<h4>实验内容</h4>
 					<textarea id="input-modify-class-2" type="text" class="form-control"></textarea>
+					<h4>开始时间</h4>
+					<input id="input-add-class-3" type="text" class="form-control" placeholder="2000-01-01 20:00"></input>    <!--#modify-->
+					<h4>结束时间</h4>
+					<input id="input-add-class-4" type="text" class="form-control" placeholder="2000-01-01 20:00"></input>    <!--#modify-->
+					<h4>实验地点</h4>
+					<input id="input-add-class-5" type="text" class="form-control"></input>
 				</div>
 				<div class="modal-footer">
 					<button class="btn btn-primary" onclick="modifyClass()" data-dismiss="modal">修改</button>
@@ -153,6 +165,23 @@
 		</div>
 	</div>
 	
+	<div class="modal fade" id="modal-delete" tabindex="-1" role="dialog" aria-hidden="true">
+		<div class="modal-dialog">
+			<div class="modal-content">
+				<div class="modal-header">
+					<button class="close" type="button" data-dismiss="modal">×</button>
+					<h3>确认删除？</h3>
+				</div>
+				<div class="modal-body">
+				</div>
+				<div class="modal-footer">
+					<button class="btn btn-primary" onclick="deleteItem()" data-dismiss="modal">确认</button>
+					<button class="btn btn-default" data-dismiss="modal">取消</button>
+				</div>
+			</div>
+		</div>
+	</div>
+	
 	<script type="text/javascript">
 	
 		var info,choosei,choosej,choosek,usersId;
@@ -161,7 +190,7 @@
 		{
 			var text1,i;
 			text1=$("#input-semester-1")[0].value;
-			$.post('/manage/AddCourseToCurrentUser',{name: text1,description: ""},
+			$.post('/manage/AddCourseToCurrentUser',{name: text1,description: ""},   //#modify
     		function(data)
     		{
     			if (data=="fail")
@@ -189,10 +218,13 @@
 		
 		function confirmCourse()  //新课程的信息
 		{
-			var text1,text2,i;
+			var text1,text2,i,p;
 			text1=$("#input-add-course-1")[0].value;
 			text2=$("#input-add-course-2")[0].value;
-			$.post('/manage/AddCourseToCurrentUser',{name: text1,description: text2},
+			p=new Object();
+			p.name=text1;
+			p.description=text2;
+			$.post('/manage/AddCourseToCurrentUser',{name: text1,description: text2},  //#modify
     		function(data)
     		{
     			if (data=="fail")
@@ -206,9 +238,7 @@
     				{
     					info.semesters[choosei].courses[i]=info.semesters[choosei].courses[i-1];
     				}
-    				info.semesters[choosei].courses[0]=new Object();
-    				info.semesters[choosei].courses[0].name=text1;
-    				info.semesters[choosei].courses[0].description=text2;
+    				info.semesters[choosei].courses[0]=p;
     				info.semesters[choosei].courses[0].tot=0;
     				info.semesters[choosei].courses[0].classes=new Array();
     				showInfo();
@@ -221,10 +251,13 @@
     	
     	function modifyCourse()    //修改课程信息
     	{
-    		var text1,text2,i;
+    		var text1,text2,i,p;
     		text1=$("#input-modify-course-1")[0].value;
 			text2=$("#input-modify-course-2")[0].value;
-			$.post('/manage/AddCourseToCurrentUser',{name: text1,description: text2},
+			p=new Object();
+			p.name=text1;
+			p.description=text2;
+			$.post('/manage/AddCourseToCurrentUser',{name: text1,description: text2},  //#modify
     		function(data)
     		{
     			if (data=="fail")
@@ -234,8 +267,7 @@
     			}
     			if (data=="succeed")
     			{
-    				info.semesters[choosei].courses[choosej].name=text1;
-    				info.semesters[choosei].courses[choosej].description=text2;
+    				info.semesters[choosei].courses[choosej]=p;
     				showInfo();
     				return;
     			}
@@ -246,10 +278,19 @@
 		
 		function confirmClass()  //新实验的信息
 		{
-			var text1,text2,i;
+			var text1,text2,text3,text4,text5,i,p;
 			text1=$("#input-add-class-1")[0].value;
 			text2=$("#input-add-class-2")[0].value;
-			$.post('/manage/AddCourseToCurrentUser',{name: text1,description: text2},
+			text3=$("#input-add-class-3")[0].value;
+			text4=$("#input-add-class-4")[0].value;
+			text5=$("#input-add-class-5")[0].value;
+			p=new Object();
+			p.name=text1;
+			p.description=text2;
+			p.start_time=text3;
+			p.end_time=text4;
+			p.location=text5;
+			$.post('/manage/AddCourseToCurrentUser',{name: text1,description: text2},  //#modify
     		function(data)
     		{
     			if (data=="fail")
@@ -263,9 +304,7 @@
     				{
     					info.semesters[choosei].courses[choosej].classes[i]=info.semesters[choosei].courses[choosej].classes[i-1];
     				}
-    				info.semesters[choosei].courses[choosej].classes[0]=new Object();
-    				info.semesters[choosei].courses[choosej].classes[0].name=text1;
-    				info.semesters[choosei].courses[choosej].classes[0].description=text2;
+    				info.semesters[choosei].courses[choosej].classes[0]=p;
     				showInfo();
     				return;
     			}
@@ -276,10 +315,19 @@
 		
 		function modifyClass()  //修改实验信息
 		{
-			var text1,text2,i;
+			var text1,text2,text3,text4,text5,i,p;
 			text1=$("#input-modify-class-1")[0].value;
 			text2=$("#input-modify-class-2")[0].value;
-			$.post('/manage/AddCourseToCurrentUser',{name: text1,description: text2},
+			text3=$("#input-modify-class-3")[0].value;
+			text4=$("#input-modify-class-4")[0].value;
+			text5=$("#input-modify-class-5")[0].value;
+			p=new Object();
+			p.name=text1;
+			p.description=text2;
+			p.start_time=text3;
+			p.end_time=text4;
+			p.location=text5;
+			$.post('/manage/AddCourseToCurrentUser',{name: text1,description: text2},  //#modify
     		function(data)
     		{
     			if (data=="fail")
@@ -289,8 +337,7 @@
     			}
     			if (data=="succeed")
     			{
-    				info.semesters[choosei].courses[choosej].classes[choosek].name=text1;
-    				info.semesters[choosei].courses[choosej].classes[choosek].description=text2;
+    				info.semesters[choosei].courses[choosej].classes[choosek]=p;
     				showInfo();
     				return;
     			}
@@ -299,6 +346,63 @@
     		);
 		}
 		
+		function deleteItem()
+		{
+			var id=-1,i;
+			if (choosek==-1)    //删除课程
+			{
+				id=info.semesters[choosei].courses[choosej].id;
+				$.delete('/courses/'+id+'.json',{},
+				function(data)
+				{
+					if (data=="fail")
+    				{
+    					alert("删除失败");
+    					return;
+    				}
+    				if (data=="succeed")
+    				{
+    					for (i=choosej;i<info.semesters[choosei].tot-1;++i)
+    					{
+  							info.semesters[choosei].courses[i]=info.semesters[choosei].courses[i+1];
+  						}
+  						--info.semesters[choosei].tot;
+    					info.semesters[choosei].courses[choosej].classes[choosek]=p;
+    					showInfo();
+    					return;
+    				}
+    				alert("unexpected:"+data);
+    				}
+    			);
+    		}else   //删除实验
+    		{
+    			id=info.semesters[choosei].courses[choosej].classes[choosek].id;
+				$.delete('/lessons/'+id+'.json',{},
+				function(data)
+				{
+					if (data=="fail")
+    				{
+    					alert("删除失败");
+    					return;
+    				}
+    				if (data=="succeed")
+    				{
+    					for (i=choosek;i<info.semesters[choosei].courses[choosej].tot-1;++i)
+    					{
+  							info.semesters[choosei].courses[choosej].classes[i]=info.semesters[choosei].courses[choosej].classes[i+1];
+  						}
+  						--info.semesters[choosei].courses[choosej].tot;
+    					info.semesters[choosei].courses[choosej].classes[choosek]=p;
+    					showInfo();
+    					return;
+    				}
+    				alert("unexpected:"+data);
+    				}
+    			);
+    		}
+		}
+					
+		
 		function loadInfo()  //从后台获取课程信息
 		{
 			info=new Object();
@@ -319,12 +423,14 @@
 					info.semesters[i].courses[j].name="大学物理"+j;
 					info.semesters[i].courses[j].description="a";
 					info.semesters[i].courses[j].classes=new Array();
+					info.semesters[i].courses[j].id=0;
 					info.semesters[i].courses[j].clicked=false;
 					for (k=0;k<=info.semesters[i].courses[j].tot;++k)
 					{
 						info.semesters[i].courses[j].classes[k]=new Object();
 						info.semesters[i].courses[j].classes[k].name="实验"+k;
 						info.semesters[i].courses[j].classes[k].description="a";
+						info.semesters[i].courses[j].classes[k].id=0;
 						info.semesters[i].courses[j].classes[k].clicked=false;
 					}
 				}
@@ -403,6 +509,9 @@
 			console.log(i,j,k);
 			$("#input-modify-class-1")[0].value=info.semesters[i].courses[j].classes[k].name;
 			$("#input-modify-class-2")[0].value=info.semesters[i].courses[j].classes[k].description;
+			$("#input-modify-class-3")[0].value=info.semesters[choosei].courses[choosej].classes[choosek].start_time;
+			$("#input-modify-class-4")[0].value=info.semesters[choosei].courses[choosej].classes[choosek].end_time;
+			$("#input-modify-class-5")[0].value=info.semesters[choosei].courses[choosej].classes[choosek].location;
 			choosei=i;choosej=j;choosek=k;
 			$('#modal-modify-class').modal('show');
 			event.stopPropagation();
@@ -427,27 +536,46 @@
 		{
 			choosei=i;choosej=j;
 			$("#input-add-class-1")[0].value=$("#input-add-class-2")[0].value="";
+			$("#input-add-class-3")[0].value=$("#input-add-class-4")[0].value=$("#input-add-class-5")[0].value="";
 			$('#modal-add-class').modal('show');
 			event.stopPropagation();
 		}
 		
 		function showCourseScore(event,i,j)  //显示第i学期第j门课的学生成绩
 		{
+			window.open("/manage/CourseScore/"+info.semesters[i].courses[j].id);
 			event.stopPropagation();
 		}
 		
 		function showCourseInfo(event,i,j)  //显示第i学期第j门课的课程信息
 		{
+			window.open("/manage/CourseInfo/"+info.semesters[i].courses[j].id);
 			event.stopPropagation();
 		}
 		
 		function showClassScore(event,i,j,k)  //显示第i学期第j门课的第k个实验的学生成绩
 		{
+			window.open("/manage/ClassScore/"+info.semesters[i].courses[j].id+"&"+info.semesters[i].courses[j].classes[k].id);
 			event.stopPropagation();
 		}
 		
 		function showClassInfo(event,i,j,k)  //显示第i学期第j门课的第k个实验的课程信息
 		{
+			window.open("/manage/ClassInfo/"+info.semesters[i].courses[j].id+"&"+info.semesters[i].courses[j].classes[k].id);
+			event.stopPropagation();
+		}
+		
+		function deleteCourse(event,i,j)  //删除第i学期第j门课
+		{
+			choosei=i;choosej=j;choosek=-1;
+			$('#modal-delete').modal('show');
+			event.stopPropagation();
+		}
+		
+		function deleteClass(event,i,j,k)  //删除第i学期第j门课的第k个实验
+		{
+			choosei=i;choosej=j;choosek=k;
+			$('#modal-delete').modal('show');
 			event.stopPropagation();
 		}
 		
@@ -476,6 +604,7 @@
 				{
 					text+='<div class="rectangleCourse btn btn-default" onclick="change('+i+','+j+','+k+')">';
 					text+='<div class="names">'+info.semesters[i].courses[j].name+'</div>';
+					text+='<div class="custombutton" onclick="deleteCourse(event,'+i+','+j+')">×</div>';
 					text+='<div class="btn btn-info custombutton" onclick="changeCourseInfo(event,'+i+','+j+')">查看|修改信息</div>';
 					text+='<div class="btn btn-info custombutton" onclick="addClass(event,'+i+','+j+')">添加实验</div>';
 					text+='<div class="btn btn-info custombutton" onclick="showCourseScore(event,'+i+','+j+')">查看成绩</div>';
@@ -487,6 +616,7 @@
 						{
 							text+='<div class="rectangleClass btn btn-default" onclick="change('+i+','+j+','+k+')">';
 							text+='<div class="names">'+info.semesters[i].courses[j].classes[k].name+'</div>';
+							text+='<div class="custombutton" onclick="deleteClass(event,'+i+','+j+','+k+')">×</div>';
 							text+='<div class="btn btn-info custombutton" onclick="changeClassInfo(event,'+i+','+j+','+k+')">查看|修改信息</div>';
 							text+='<div class="btn btn-info custombutton" onclick="showClassScore(event,'+i+','+j+','+k+')">查看成绩</div>';
 							text+='<div class="btn btn-info custombutton" onclick="showClassInfo(event,'+i+','+j+','+k+')">实验情况</div>';
-- 
1.9.1

