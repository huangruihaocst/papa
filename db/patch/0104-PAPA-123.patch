From 785b8d47ac46b337c64a12c8285210d8a94cb3d0 Mon Sep 17 00:00:00 2001
From: luogan <luogan_62625686@126.com>
Date: Sun, 18 Oct 2015 11:16:08 +0800
Subject: [PATCH 104/150] PAPA-123

---
 app/views/manage/class_info.html.erb | 97 +++++++++++++++++++++++-------------
 1 file changed, 61 insertions(+), 36 deletions(-)

diff --git a/app/views/manage/class_info.html.erb b/app/views/manage/class_info.html.erb
index eb573b7..473b7e0 100644
--- a/app/views/manage/class_info.html.erb
+++ b/app/views/manage/class_info.html.erb
@@ -15,22 +15,30 @@
 		{
 			font-size:25px;
 			margin-top:30px;
+			text-align:left;
 		}
 		.author
 		{
 			font-size:15px;
 			margin-top:2px;
+			text-align:left;
 		}
 		.chart
 		{
 			width:100%;
 			height:300px;
 		}
+		#title
+		{
+			font-size:40px;
+		}
 	</style>
 </head>
 <body>
 	<script type="text/javascript" src="/chart.js"></script>
 	<div id="content">
+		<div id="title">
+		</div>
 		<div id="content1" class="content">
 			到课情况</br>
 			<canvas id="chart1" class="chart"></canvas>
@@ -55,7 +63,7 @@
 			classId=p.split("&")[1];
 		}
 		
-		var n,courseInfo,comments=new Array(),people=new Object(),score=new Array(11);
+		var n,classInfo,comments=new Array(),people=new Object(),score=new Array(11);
 		
 		$("#chart1")[0].height=$("#chart1")[0].width;
 		$("#chart2")[0].height=$("#chart2")[0].width;
@@ -65,9 +73,28 @@
 		{
 			people.attend=100;people.absense=10;
 			for (i=0;i<11;++i) score[i]=10;
+			classInfo="计算机组成原理";
+			var i;
+			n=100;
+			for (i=0;i<n;++i)
+			{
+				comments[i]=new Object();
+				comments[i].author="A"+i;
+				comments[i].text="aaa";
+			}
+			totalPages=Math.floor((n-1)/numberPerPage+1);
+			nowPage=1;
+			showInfo();
+			var p1=false,p2=false,p3=false,p4=false;
+			function deal()
+			{
+				people.absense=people.tot-people.attend;
+				showInfo();
+			}
 			$.get("/lessons/"+classId+".json",{},
 			function(data)
 			{
+				console.log(data);
 				if (data.status=="failed")
 				{
 					alert("获取实验信息失败");
@@ -75,25 +102,17 @@
 				}
 				if (data.status=="successful")
 				{
-					courseInfo=data.name;
+					classInfo=data.name;
+					p1=true;
+					if (p1&&p2&&p3&&p4) deal();
 					return;
 				}
 				alert("unexpected: /lessons/id.json");
 			});
-			courseInfo="计算机组成原理";
-			var i;
-			n=100;
-			for (i=0;i<n;++i)
-			{
-				comments[i]=new Object();
-				comments[i].author="A"+i;
-				comments[i].text="aaa";
-			}
-			totalPages=Math.floor((n-1)/numberPerPage+1);
-			nowPage=1;
 			$.get("/courses/"+courseId+"/students.json",{},
 			function(data)
 			{
+				console.log(data);
 				if (data.status=="failed")
 				{
 					alert("获取课程人数失败");
@@ -101,7 +120,9 @@
 				}
 				if (data.status=="successful")
 				{
-					people.tot=data.students.size();
+					people.tot=data.students.length;
+					p2=true;
+					if (p1&&p2&&p3&&p4) deal();
 					return;
 				}
 				alert("unexpected: /courses/id/students.json");
@@ -109,6 +130,7 @@
 			$.get("/lessons/"+classId+"/students.json",{},
 			function(data)
 			{
+				console.log(data);
 				if (data.status=="failed")
 				{
 					alert("获取到课人数失败");
@@ -116,33 +138,36 @@
 				}
 				if (data.status=="successful")
 				{
-					people.attend=data.size();
-					people.absense=people.tot-people.attend;
-					var i;
-					for (i=0;i<data.id.length;++i)
-					{
-						$.get("/lessons/"+classId+"/students/"+data.id[i]+"/comments.json",{},
-						function(data2)
-						{
-							if (data2.status=="failed")
-							{
-								alert("获取实验信息失败");
-								return;
-							}
-							if (data2.status=="successful")
-							{
-								++score[data2.score];
-							}
-							alert("unexpected: /lessons/id/students/id/comments.json");
-						});
-					}
+					data.students.length;
+					p3=true;
+					if (p1&&p2&&p3&&p4) deal();
+					return;
 				}
 				alert("unexpected: /lessons/id/students.json");
 			});
 			$.get("/lessons/"+classId+"/comments.json",{},
 			function(data)
 			{
-				comments[n++]=data;
+				console.log(data);
+				if (data.status=="failed")
+				{
+					alert("获取评论失败");
+					return;
+				}
+				if (data.status=="successful")
+				{
+					var i;
+					data=data.lesson_comments;
+					for (i=0;i<data.length;++i)
+					{
+						comments[n++]=data[i];
+						score[data[i].score]++;
+					}
+					p4=true;
+					if (p1&&p2&&p3&&p4) deal();
+					return;
+				}
+				alert("unexpected: /lessons/id/comments.json");
 			});
 		}
 		
@@ -174,6 +199,7 @@
 		function showInfo()
 		{
 			var data,data2,text="",i;
+			$("#title")[0].innerHTML=classInfo;
 			data={labels:["上课人数","缺勤人数"],datasets:[{
 					fillColor : "rgba(151,187,205,0.5)",
 					strokeColor : "rgba(151,187,205,1)",
@@ -191,6 +217,5 @@
 		}
 		
 		loadInfo();
-		showInfo();
 	</script>
 </body>
-- 
1.9.1

