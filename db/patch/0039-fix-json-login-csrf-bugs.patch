From 6a46585d0f33aadee86a192787278c851b43356d Mon Sep 17 00:00:00 2001
From: Alex Wang <ice_b0und@hotmail.com>
Date: Thu, 8 Oct 2015 22:26:14 +0800
Subject: [PATCH 039/150] fix json login csrf bugs

---
 Gemfile                                           | 2 +-
 Gemfile.lock                                      | 3 +++
 README.md                                         | 5 ++++-
 app/controllers/application_controller.rb         | 3 ++-
 app/controllers/users/registrations_controller.rb | 8 ++++----
 app/models/user.rb                                | 1 -
 config/routes.rb                                  | 5 ++++-
 7 files changed, 18 insertions(+), 9 deletions(-)

diff --git a/Gemfile b/Gemfile
index 83f14dd..4e44363 100644
--- a/Gemfile
+++ b/Gemfile
@@ -28,7 +28,7 @@ gem 'bootstrap-sass', '~> 3.3.5'
 
 # Use Devise for authentication
 gem 'devise'
-
+gem 'devise-encryptable'
 # Use for Chinese support
 gem 'rails-i18n'
 
diff --git a/Gemfile.lock b/Gemfile.lock
index 5c6c5e8..a885b40 100644
--- a/Gemfile.lock
+++ b/Gemfile.lock
@@ -62,6 +62,8 @@ GEM
       responders
       thread_safe (~> 0.1)
       warden (~> 1.2.3)
+    devise-encryptable (0.2.0)
+      devise (>= 2.1.0)
     erubis (2.7.0)
     execjs (2.6.0)
     globalid (0.3.6)
@@ -168,6 +170,7 @@ DEPENDENCIES
   bootstrap-sass (~> 3.3.5)
   coffee-rails (~> 4.1.0)
   devise
+  devise-encryptable
   jbuilder (~> 2.0)
   jquery-rails
   rails (= 4.2.4)
diff --git a/README.md b/README.md
index 84ffe32..a7ce6fe 100644
--- a/README.md
+++ b/README.md
@@ -71,7 +71,10 @@ Android客户端通过访问指定的URL获得一个JSON文件来访问数据库
 }
 
 ###登陆
-POST /users/sign_in     login=phone&encrpyted_password=xxx
+POST /users/sign_in.json     utf8=✓&user[login]=xxx&user[password]=123&user[remember_me]=0
+                                                ^                  ^
+                                  此处可以是电话或者email    密码为明文，用https保证安全性 注意要 URL-Encode
+                                  上面对号的utf-8编码值为0xE2 0x9C 0x93
 返回json
 { 
     status: 'successful'/'faild',
diff --git a/app/controllers/application_controller.rb b/app/controllers/application_controller.rb
index 20e3396..20ded08 100644
--- a/app/controllers/application_controller.rb
+++ b/app/controllers/application_controller.rb
@@ -1,7 +1,8 @@
 class ApplicationController < ActionController::Base
   # Prevent CSRF attacks by raising an exception.
   # For APIs, you may want to use :null_session instead.
-  protect_from_forgery with: :exception
+  #protect_from_forgery with: :exception
+
   before_action :configure_permitted_parameters, if: :devise_controller?
 
   def json_failed(reason = nil)
diff --git a/app/controllers/users/registrations_controller.rb b/app/controllers/users/registrations_controller.rb
index 74788ca..ce6a407 100644
--- a/app/controllers/users/registrations_controller.rb
+++ b/app/controllers/users/registrations_controller.rb
@@ -7,10 +7,10 @@ class Users::RegistrationsController < Devise::RegistrationsController
   #   super
   # end
 
-  # POST /resource
-  def create
-     super
-  end
+  # # POST /resource
+  # def create
+  #    super
+  # end
 
   # GET /resource/edit
   # def edit
diff --git a/app/models/user.rb b/app/models/user.rb
index 55e991c..a681431 100644
--- a/app/models/user.rb
+++ b/app/models/user.rb
@@ -32,5 +32,4 @@ class User < ActiveRecord::Base
   def create_token
     Token.create(user_id: id, token: Token.safe_token, valid_until: Time.now + TOKEN_VALID_TIME_SEC)
   end
-
 end
diff --git a/config/routes.rb b/config/routes.rb
index 8f87fa8..30810fe 100644
--- a/config/routes.rb
+++ b/config/routes.rb
@@ -1,6 +1,9 @@
 Rails.application.routes.draw do
 
-  devise_for :users, controllers: { sessions: 'users/sessions' }
+  devise_for :users, controllers: {
+    sessions: 'users/sessions',
+    registrations: 'users/registrations'
+  }
 
   resources :courses do
     resources :students
-- 
1.9.1

