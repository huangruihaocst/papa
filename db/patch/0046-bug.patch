From 8c05bf391fea8c9f9e6f58414ab39bb7888a65c3 Mon Sep 17 00:00:00 2001
From: luogan <luogan_62625686@126.com>
Date: Fri, 9 Oct 2015 17:06:52 +0800
Subject: [PATCH 046/150] =?UTF-8?q?=E6=B7=BB=E5=8A=A0=E4=BA=86=E6=B7=BB?=
 =?UTF-8?q?=E5=8A=A0=E8=AF=BE=E7=A8=8B=E5=8A=9F=E8=83=BD+=E4=BF=AE?=
 =?UTF-8?q?=E8=A1=A5=E4=BA=86=E4=B8=80=E4=BA=9Bbug?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 app/views/manage/class_info.html.erb   |   7 +-
 app/views/manage/class_score.html.erb  |  12 +-
 app/views/manage/course_info.html.erb  |   7 +-
 app/views/manage/course_score.html.erb |   8 +-
 app/views/manage/main_page.html.erb    | 200 ++++++++++++++++++++++++++-------
 app/views/manage/show_photos.html.erb  |   7 +-
 app/views/manage/show_videos.html.erb  |   7 +-
 db/schema.rb                           |   3 +-
 public/common.css                      |   6 +
 9 files changed, 178 insertions(+), 79 deletions(-)
 create mode 100644 public/common.css

diff --git a/app/views/manage/class_info.html.erb b/app/views/manage/class_info.html.erb
index c08d7e7..fc40293 100644
--- a/app/views/manage/class_info.html.erb
+++ b/app/views/manage/class_info.html.erb
@@ -1,11 +1,6 @@
 <head>
+	<link href="/common.css" rel=stylesheet type="text/css">
 	<style type="text/css">
-		#content
-		{
-			padding-left:20%;
-			padding-right:20%;
-			padding-top:3%:
-		}
 		.content
 		{
 			width:50%;
diff --git a/app/views/manage/class_score.html.erb b/app/views/manage/class_score.html.erb
index b03200b..969b9bc 100644
--- a/app/views/manage/class_score.html.erb
+++ b/app/views/manage/class_score.html.erb
@@ -1,13 +1,8 @@
 <head>
-	<meta http-equiv="content-type" content="text/html; charset=gb2312">  
-  	<meta name="author" content="oscar999">  
+	<meta http-equiv="content-type" content="text/html; charset=gb2312">
+  	<meta name="author" content="oscar999">
+  	<link href="/common.css" rel=stylesheet type="text/css">
 	<style type="text/css">
-		#content
-		{
-			padding-left:20%;
-			padding-right:20%;
-			padding-top:3%:
-		}
 		.custombutton
 		{
 			width:100%;
@@ -75,6 +70,7 @@
 		
 		function option(x)
 		{
+			if (focusi!=-1&&focusj!=-1) return;
 			if (x!=lastChoose) lastChoose=x,p=0;
 			else p=1-p;
 			console.log(x,p);
diff --git a/app/views/manage/course_info.html.erb b/app/views/manage/course_info.html.erb
index 99eb869..550f8fc 100644
--- a/app/views/manage/course_info.html.erb
+++ b/app/views/manage/course_info.html.erb
@@ -1,11 +1,6 @@
 <head>
+	<link href="/common.css" rel=stylesheet type="text/css">
 	<style type="text/css">
-		#content
-		{
-			padding-left:20%;
-			padding-right:20%;
-			padding-top:3%:
-		}
 		.content
 		{
 			width:50%;
diff --git a/app/views/manage/course_score.html.erb b/app/views/manage/course_score.html.erb
index 042330f..a81a99f 100644
--- a/app/views/manage/course_score.html.erb
+++ b/app/views/manage/course_score.html.erb
@@ -1,11 +1,6 @@
 <head>
+	<link href="/common.css" rel=stylesheet type="text/css">
 	<style type="text/css">
-		#content
-		{
-			padding-left:20%;
-			padding-right:20%;
-			padding-top:3%:
-		}
 		.custominput
 		{
 		}
@@ -66,6 +61,7 @@
 		
 		function option(x)
 		{
+			if (focusi!=-1&&focusj!=-1) return;
 			if (x!=lastChoose) lastChoose=x,p=0;
 			else p=1-p;
 			qsort(0,m-1,x,p);
diff --git a/app/views/manage/main_page.html.erb b/app/views/manage/main_page.html.erb
index 82866c1..910496a 100644
--- a/app/views/manage/main_page.html.erb
+++ b/app/views/manage/main_page.html.erb
@@ -1,11 +1,6 @@
 <head>
+	<link href="/common.css" rel=stylesheet type="text/css">
 	<style type="text/css">
-		#content
-		{
-			padding-left:20%;
-			padding-right:20%;
-			padding-top:3%:
-		}
 		.rectangleSemester
 		{
 			width:100%;
@@ -51,34 +46,141 @@
 	</style>
 </head>
 <body>
+
 	<div id="content">
-	</div> 
+	</div>
+	
+	<div class="modal fade" id="modal-add-course" tabindex="-1" role="dialog" aria-hidden="true">
+		<div class="modal-dialog">
+			<div class="modal-content">
+				<div class="modal-header">
+					<button class="close" type="button" data-dismiss="modal">×</button>
+					<h3>添加课程</h3>
+				</div>
+				<div class="modal-body">
+					<h4>课程标题</h4>
+					<input id="input1" type="text" class="form-control"></input>
+					<h4>课程内容</h4>
+					<textarea id="input2" type="text" class="form-control"></textarea>
+				</div>
+				<div class="modal-footer">
+					<button class="btn btn-primary" onclick="confirmCourse()" data-dismiss="modal">添加</button>
+					<button class="btn btn-default" data-dismiss="modal">取消</button>
+				</div>
+			</div>
+		</div>
+	</div>
+	
+	<div class="modal fade" id="modal-add-class" tabindex="-1" role="dialog" aria-hidden="true">
+		<div class="modal-dialog">
+			<div class="modal-content">
+				<div class="modal-header">
+					<button class="close" type="button" data-dismiss="modal">×</button>
+					<h3>添加实验</h3>
+				</div>
+				<div class="modal-body">
+					<h4>实验标题</h4>
+					<input id="input3" type="text" class="form-control"></input>
+					<h4>实验内容</h4>
+					<textarea id="input4" type="text" class="form-control"></textarea>
+				</div>
+				<div class="modal-footer">
+					<button class="btn btn-primary" onclick="confirmClass()" data-dismiss="modal">添加</button>
+					<button class="btn btn-default" data-dismiss="modal">取消</button>
+				</div>
+			</div>
+		</div>
+	</div>
 	
 	<script type="text/javascript">
 	
-		var semesters=new Array(),courses=new Array(),classes=new Array();
+		var info,choosei,choosej,choosek;
+		
+		function confirmCourse()  //向后台传输新课程的信息
+		{
+			var text1,text2,i;
+			text1=$("#input1")[0].value;
+			text2=$("#input2")[0].value;
+			var reg=new RegExp("\r\n","g");
+			text2=text2.replace(reg,"<br>");
+			$.post('/manage/AddCourseToCurrentUser',{name: text1,description: text2},
+    		function(data)
+    		{
+    			if (data=="fail")
+    			{
+    				alert("添加失败");
+    				return;
+    			}
+    			if (data=="succeed")
+    			{
+    				i=info.semesters[choosei].tot++;
+    				info.semesters[choosei].courses[i]=new Object();
+    				info.semesters[choosei].courses[i].name=text1;
+    				info.semesters[choosei].courses[i].content=text2;
+    				info.semesters[choosei].courses[i].tot=0;
+    				info.semesters[choosei].courses[i].classes=new Array();
+    				showInfo();
+    				return;
+    			}
+    			alert("unexpected:"+data);
+    		}
+    		);
+		}
+		
+		function confirmClass()  //向后台传输新实验的信息
+		{
+			var text1,text2,i;
+			text1=$("#input3")[0].value;
+			text2=$("#input4")[0].value;
+			$.post('/manage/AddCourseToCurrentUser',{name: text1,description: text2},
+    		function(data)
+    		{
+    			if (data=="fail")
+    			{
+    				alert("添加失败");
+    				return;
+    			}
+    			if (data=="succeed")
+    			{
+    				i=info.semesters[choosei].courses[choosej].tot++;
+    				info.semesters[choosei].courses[choosej].classes[i]=new Object();
+    				info.semesters[choosei].courses[choosej].classes[i].name=text1;
+    				info.semesters[choosei].courses[choosej].classes[i].content=text2;
+    				showInfo();
+    				return;
+    			}
+    			alert("unexpected:"+data);
+    		}
+    		);
+		}
 		
 		function loadInfo()  //从后台获取课程信息
 		{
+			info=new Object();
+			info.tot=2;
+			info.semesters=new Array();
 			var i,j,k;
-			for (i=0;i<=1;++i)
+			for (i=0;i<info.tot;++i)
 			{
-				semesters[i]=new Object();
-				semesters[i].name="2015年"+i;
-				courses[i]=new Array();
-				classes[i]=new Array();
-				semesters[i].clicked=false;
-				for (j=0;j<=1;++j)
+				info.semesters[i]=new Object();
+				info.semesters[i].tot=2;
+				info.semesters[i].name="2015年"+i;
+				info.semesters[i].courses=new Array();
+				info.semesters[i].clicked=false;
+				for (j=0;j<info.semesters[i].tot;++j)
 				{
-					courses[i][j]=new Object();
-					courses[i][j].name="大学物理"+j;
-					classes[i][j]=new Array();
-					courses[i][j].clicked=false;
-					for (k=0;k<=1;++k)
+					info.semesters[i].courses[j]=new Object();
+					info.semesters[i].courses[j].tot=2;
+					info.semesters[i].courses[j].name="大学物理"+j;
+					info.semesters[i].courses[j].content="a";
+					info.semesters[i].courses[j].classes=new Array();
+					info.semesters[i].courses[j].clicked=false;
+					for (k=0;k<=info.semesters[i].courses[j].tot;++k)
 					{
-						classes[i][j][k]=new Object();
-						classes[i][j][k].name="实验"+k;
-						classes[i][j][k].clicked=false;
+						info.semesters[i].courses[j].classes[k]=new Object();
+						info.semesters[i].courses[j].classes[k].name="实验"+k;
+						info.semesters[i].courses[j].classes[k].content="a";
+						info.semesters[i].courses[j].classes[k].clicked=false;
 					}
 				}
 			}
@@ -87,21 +189,27 @@
 		function change(i,j,k)  //i, j, k分别表示当前点击的学期，课程，实验
 		{
 			if (k!=-1)
-			classes[i][j][k].clicked=!classes[i][j][k].clicked;
+			info.semesters[i].courses[j].classes[k].clicked=!info.semesters[i].courses[j].classes[k].clicked;
 			else if (j!=-1)
-			courses[i][j].clicked=!courses[i][j].clicked;
+			info.semesters[i].courses[j].clicked=!info.semesters[i].courses[j].clicked;
 			else if (i!=-1)
-			semesters[i].clicked=!semesters[i].clicked;
+			info.semesters[i].clicked=!info.semesters[i].clicked;
 			showInfo();
 		}
 		
 		function addCourse(event,i)  //为第i学期添加课程
 		{
+			choosei=i;
+			$("#input1")[0].value=$("#input2")[0].value="";
+			$('#modal-add-course').modal('show');
 			event.stopPropagation();
 		}
 		
 		function addClass(event,i,j) //为第i学期第j门课添加实验
 		{
+			choosei=i;choosej=j;
+			$("#input3")[0].value=$("#input4")[0].value="";
+			$('#modal-add-class').modal('show');
 			event.stopPropagation();
 		}
 		 
@@ -125,39 +233,50 @@
 			event.stopPropagation();
 		}
 		
+		function check(str)
+		{
+			console.log(str);
+			return str;
+		}
+		
 
 		function showInfo()  //显示课程信息
 		{
 			var i,j,k,text="";j=k=-1;
-			for (i=0;i<semesters.length;++i)
+			for (i=0;i<info.tot;++i)
 			{
 				text+='<div class="rectangleSemester btn btn-default" onclick="change('+i+','+j+','+k+')">';
-				text+='<div class="names">'+semesters[i].name+'</div>';
+				text+='<div class="names">'+info.semesters[i].name+'</div>';
 				text+='<div class="btn btn-info custombutton" onclick="addCourse(event,'+i+')">添加课程</div>';
 				text+='</div>';
 				k=-1;
-				if (semesters[i].clicked)
-				for (j=0;j<courses[i].length;++j)
+				if (info.semesters[i].clicked)
+				for (j=0;j<info.semesters[i].tot;++j)
 				{
 					text+='<div class="rectangleCourse btn btn-default" onclick="change('+i+','+j+','+k+')">';
-					text+='<div class="names">'+courses[i][j].name+'</div>';
+					text+='<div class="names">'+info.semesters[i].courses[j].name+'</div>';
 					text+='<div class="btn btn-info custombutton" onclick="addClass(event,'+i+','+j+')">添加实验</div>';
 					text+='<div class="btn btn-info custombutton" onclick="showCourseScore(event,'+i+','+j+')">查看成绩</div>';
 					text+='<div class="btn btn-info custombutton" onclick="showCourseInfo(event,'+i+','+j+')">课程情况</div>';
 					text+='</div>';
-					if (courses[i][j].clicked)
-					for (k=0;k<classes[i][j].length;++k)
+					if (info.semesters[i].courses[j].clicked)
 					{
-						text+='<div class="rectangleClass btn btn-default" onclick="change('+i+','+j+','+k+')">';
-						text+='<div class="names">'+classes[i][j][k].name+'</div>';
-						text+='<div class="btn btn-info custombutton" onclick="showClassScore(event,'+i+','+j+','+k+')">查看成绩</div>';
-						text+='<div class="btn btn-info custombutton" onclick="showClassInfo(event,'+i+','+j+','+k+')">实验情况</div>';
+						text+='<div class="rectangleCourseContent btn btn-default">';
+						text+=check(info.semesters[i].courses[j].content);
 						text+='</div>';
-						if (classes[i][j][k].clicked)
+						for (k=0;k<info.semesters[i].courses[j].tot;++k)
 						{
-							text+='<div class="rectangleClassContent btn btn-default">';
-							text+='ddd';
+							text+='<div class="rectangleClass btn btn-default" onclick="change('+i+','+j+','+k+')">';
+							text+='<div class="names">'+info.semesters[i].courses[j].classes[k].name+'</div>';
+							text+='<div class="btn btn-info custombutton" onclick="showClassScore(event,'+i+','+j+','+k+')">查看成绩</div>';
+							text+='<div class="btn btn-info custombutton" onclick="showClassInfo(event,'+i+','+j+','+k+')">实验情况</div>';
 							text+='</div>';
+							if (info.semesters[i].courses[j].classes[k].clicked)
+							{
+								text+='<div class="rectangleClassContent btn btn-default">';
+								text+=check(info.semesters[i].courses[j].classes[k].content);
+								text+='</div>';
+							}
 						}
 					}
 					k=-1;
@@ -171,4 +290,5 @@
 		showInfo();
 
 	</script>
+	
 </body>
diff --git a/app/views/manage/show_photos.html.erb b/app/views/manage/show_photos.html.erb
index 2552e2a..4f19cb0 100644
--- a/app/views/manage/show_photos.html.erb
+++ b/app/views/manage/show_photos.html.erb
@@ -1,11 +1,6 @@
 <head>
+	<link href="/common.css" rel=stylesheet type="text/css">
 	<style type="text/css">
-		#content
-		{
-			padding-left:20%;
-			padding-right:20%;
-			padding-top:3%:
-		}
 		#content1
 		{
 			width:100%;
diff --git a/app/views/manage/show_videos.html.erb b/app/views/manage/show_videos.html.erb
index 2552e2a..4f19cb0 100644
--- a/app/views/manage/show_videos.html.erb
+++ b/app/views/manage/show_videos.html.erb
@@ -1,11 +1,6 @@
 <head>
+	<link href="/common.css" rel=stylesheet type="text/css">
 	<style type="text/css">
-		#content
-		{
-			padding-left:20%;
-			padding-right:20%;
-			padding-top:3%:
-		}
 		#content1
 		{
 			width:100%;
diff --git a/db/schema.rb b/db/schema.rb
index feb8f36..41a9cef 100644
--- a/db/schema.rb
+++ b/db/schema.rb
@@ -23,7 +23,7 @@ ActiveRecord::Schema.define(version: 20150930115150) do
     t.text     "description"
     t.datetime "start_time"
     t.datetime "end_time"
-    t.string   "position"
+    t.string   "location"
     t.integer  "course_id"
   end
 
@@ -46,6 +46,7 @@ ActiveRecord::Schema.define(version: 20150930115150) do
     t.datetime "last_sign_in_at"
     t.string   "current_sign_in_ip"
     t.string   "last_sign_in_ip"
+    t.boolean  "is_teacher"
     t.datetime "created_at",                          null: false
     t.datetime "updated_at",                          null: false
   end
diff --git a/public/common.css b/public/common.css
new file mode 100644
index 0000000..a1a35d0
--- /dev/null
+++ b/public/common.css
@@ -0,0 +1,6 @@
+#content
+{
+	padding-left:20%;
+	padding-right:20%;
+	padding-top:3%;
+}
-- 
1.9.1

