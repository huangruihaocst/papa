From 20b35e155f6679a8c6116cbaf87d1e546eb7ee22 Mon Sep 17 00:00:00 2001
From: Alex Wang <ice_b0und@hotmail.com>
Date: Wed, 7 Oct 2015 16:48:22 +0800
Subject: [PATCH 035/150] fix email login bug

---
 app/controllers/application_controller.rb         |  9 +++++++++
 app/controllers/users/registrations_controller.rb | 16 ++++++++--------
 app/controllers/users/sessions_controller.rb      | 14 +++++++-------
 app/models/user.rb                                |  1 +
 app/views/devise/registrations/new.html.erb       |  5 +++++
 db/migrate/20150926114146_devise_create_users.rb  |  2 +-
 db/schema.rb                                      |  5 ++---
 7 files changed, 33 insertions(+), 19 deletions(-)

diff --git a/app/controllers/application_controller.rb b/app/controllers/application_controller.rb
index 1df4626..20e3396 100644
--- a/app/controllers/application_controller.rb
+++ b/app/controllers/application_controller.rb
@@ -2,6 +2,7 @@ class ApplicationController < ActionController::Base
   # Prevent CSRF attacks by raising an exception.
   # For APIs, you may want to use :null_session instead.
   protect_from_forgery with: :exception
+  before_action :configure_permitted_parameters, if: :devise_controller?
 
   def json_failed(reason = nil)
     if reason
@@ -18,4 +19,12 @@ class ApplicationController < ActionController::Base
     redirect_to '/404.html'
   end
 
+  protected
+
+  def configure_permitted_parameters
+    devise_parameter_sanitizer.for(:sign_up) { |u| u.permit(:username, :email, :password, :password_confirmation, :remember_me) }
+    devise_parameter_sanitizer.for(:sign_in) { |u| u.permit(:login, :username, :email, :password, :remember_me) }
+    devise_parameter_sanitizer.for(:account_update) { |u| u.permit(:username, :email, :password, :password_confirmation, :current_password) }
+  end
+
 end
diff --git a/app/controllers/users/registrations_controller.rb b/app/controllers/users/registrations_controller.rb
index 5ca7479..74788ca 100644
--- a/app/controllers/users/registrations_controller.rb
+++ b/app/controllers/users/registrations_controller.rb
@@ -8,9 +8,9 @@ class Users::RegistrationsController < Devise::RegistrationsController
   # end
 
   # POST /resource
-  # def create
-  #   super
-  # end
+  def create
+     super
+  end
 
   # GET /resource/edit
   # def edit
@@ -36,12 +36,12 @@ class Users::RegistrationsController < Devise::RegistrationsController
   #   super
   # end
 
-  # protected
+  protected
 
-  # If you have extra params to permit, append them to the sanitizer.
-  # def configure_sign_up_params
-  #   devise_parameter_sanitizer.for(:sign_up) << :attribute
-  # end
+  #If you have extra params to permit, append them to the sanitizer.
+  def configure_sign_up_params
+    devise_parameter_sanitizer.for(:sign_up) << :phone << :email
+  end
 
   # If you have extra params to permit, append them to the sanitizer.
   # def configure_account_update_params
diff --git a/app/controllers/users/sessions_controller.rb b/app/controllers/users/sessions_controller.rb
index 6b51b39..63606ca 100644
--- a/app/controllers/users/sessions_controller.rb
+++ b/app/controllers/users/sessions_controller.rb
@@ -34,11 +34,11 @@ class Users::SessionsController < Devise::SessionsController
     end
   end
 
-  #
-  # protected
-  #
-  # #If you have extra params to permit, append them to the sanitizer.
-  # def configure_sign_in_params
-  #   devise_parameter_sanitizer.for(:sign_in) << :attribute
-  # end
+
+  protected
+
+  #If you have extra params to permit, append them to the sanitizer.
+  def configure_sign_in_params
+    devise_parameter_sanitizer.for(:sign_in) << :login
+  end
 end
diff --git a/app/models/user.rb b/app/models/user.rb
index 66ceed5..a5a7ff0 100644
--- a/app/models/user.rb
+++ b/app/models/user.rb
@@ -13,6 +13,7 @@ class User < ActiveRecord::Base
     @login = login
   end
   def login
+
     @login || self.phone || self.email
   end
   def self.find_for_database_authentication(warden_conditions)
diff --git a/app/views/devise/registrations/new.html.erb b/app/views/devise/registrations/new.html.erb
index 5a238ce..aa43086 100644
--- a/app/views/devise/registrations/new.html.erb
+++ b/app/views/devise/registrations/new.html.erb
@@ -4,6 +4,11 @@
   <%= devise_error_messages! %>
 
   <div class="field">
+    <%= f.label :phone %><br />
+    <%= f.text_field :phone %>
+  </div>
+
+  <div class="field">
     <%= f.label :email %><br />
     <%= f.email_field :email, autofocus: true %>
   </div>
diff --git a/db/migrate/20150926114146_devise_create_users.rb b/db/migrate/20150926114146_devise_create_users.rb
index 1968db7..b59661f 100644
--- a/db/migrate/20150926114146_devise_create_users.rb
+++ b/db/migrate/20150926114146_devise_create_users.rb
@@ -3,7 +3,7 @@ class DeviseCreateUsers < ActiveRecord::Migration
     create_table(:users) do |t|
       ## Database authenticatable
       t.string :name,               null: true, default: ""
-      t.string :phone,              null: true, default: ""
+      t.string :phone,              null: true
       t.string :email,              null: false, default: ""
       t.string :encrypted_password, null: false, default: ""
 
diff --git a/db/schema.rb b/db/schema.rb
index 41c53bb..41a9cef 100644
--- a/db/schema.rb
+++ b/db/schema.rb
@@ -34,8 +34,8 @@ ActiveRecord::Schema.define(version: 20150930115150) do
   end
 
   create_table "users", force: :cascade do |t|
-    t.string   "name",                   default: "", null: false
-    t.string   "phone",                  default: "", null: false
+    t.string   "name",                   default: ""
+    t.string   "phone"
     t.string   "email",                  default: "", null: false
     t.string   "encrypted_password",     default: "", null: false
     t.string   "reset_password_token"
@@ -52,7 +52,6 @@ ActiveRecord::Schema.define(version: 20150930115150) do
   end
 
   add_index "users", ["email"], name: "index_users_on_email", unique: true
-  add_index "users", ["phone"], name: "index_users_on_phone", unique: true
   add_index "users", ["reset_password_token"], name: "index_users_on_reset_password_token", unique: true
 
 end
-- 
1.9.1

