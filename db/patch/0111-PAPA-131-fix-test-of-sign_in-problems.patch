From 1ee83aedcff5a52e44b5d8c5a8e41e4925f085a6 Mon Sep 17 00:00:00 2001
From: Alex Wang <ice_b0und@hotmail.com>
Date: Tue, 20 Oct 2015 21:55:07 +0800
Subject: [PATCH 111/150] PAPA-131 fix test of sign_in problems

---
 .python-version                                  |  1 +
 app/controllers/assistants_controller.rb         |  2 +-
 app/controllers/students_controller.rb           |  2 +-
 test/controllers/android_apps_controller_test.rb |  1 +
 test/controllers/assistants_controller_test.rb   |  5 +++++
 test/controllers/lessons_controller_test.rb      |  6 ++++--
 test/controllers/semesters_controller_test.rb    | 11 ++++++++++-
 test/controllers/students_controller_test.rb     |  8 +++++++-
 8 files changed, 30 insertions(+), 6 deletions(-)
 create mode 100644 .python-version

diff --git a/.python-version b/.python-version
new file mode 100644
index 0000000..6cb9d3d
--- /dev/null
+++ b/.python-version
@@ -0,0 +1 @@
+3.4.3
diff --git a/app/controllers/assistants_controller.rb b/app/controllers/assistants_controller.rb
index 20e7f91..2273bbd 100644
--- a/app/controllers/assistants_controller.rb
+++ b/app/controllers/assistants_controller.rb
@@ -11,7 +11,7 @@ class AssistantsController < ApplicationController
     if params[:course_id]
       begin
         course = Course.find(params[:course_id])
-        must_be_a_teacher_of(param[:token], course)
+        must_be_a_teacher_of(params[:token], course)
 
         participations = course.participations.where(role: ROLE_ASSISTANT)
         @assistants = User.none
diff --git a/app/controllers/students_controller.rb b/app/controllers/students_controller.rb
index 0d47c85..7c738d3 100644
--- a/app/controllers/students_controller.rb
+++ b/app/controllers/students_controller.rb
@@ -13,7 +13,7 @@ class StudentsController < ApplicationController
     if params[:course_id]
       begin
         course = Course.find(params[:course_id])
-        must_be_a_teacher_of(param[:token], course)
+        must_be_a_teacher_of(params[:token], course)
 
         participations = course.participations.where(role: ROLE_STUDENT)
         @students = User.none
diff --git a/test/controllers/android_apps_controller_test.rb b/test/controllers/android_apps_controller_test.rb
index b0ce70d..c99918f 100644
--- a/test/controllers/android_apps_controller_test.rb
+++ b/test/controllers/android_apps_controller_test.rb
@@ -1,6 +1,7 @@
 require 'test_helper'
 
 class AndroidAppsControllerTest < ActionController::TestCase
+  include Devise::TestHelpers
   # test "the truth" do
   #   assert true
   # end
diff --git a/test/controllers/assistants_controller_test.rb b/test/controllers/assistants_controller_test.rb
index 230202f..87d3e66 100644
--- a/test/controllers/assistants_controller_test.rb
+++ b/test/controllers/assistants_controller_test.rb
@@ -1,7 +1,12 @@
 require 'test_helper'
 
 class AssistantsControllerTest < ActionController::TestCase
+  include Devise::TestHelpers
+
   test 'api should get assistants by course' do
+    teacher = User.find_by_name('alex')
+    sign_in teacher
+
     get :index, { format: :json, course_id: Course.find_by_name('Operation System').id }
     
     assert_json_success
diff --git a/test/controllers/lessons_controller_test.rb b/test/controllers/lessons_controller_test.rb
index eacaf46..705eb62 100644
--- a/test/controllers/lessons_controller_test.rb
+++ b/test/controllers/lessons_controller_test.rb
@@ -1,9 +1,10 @@
 require 'test_helper'
 
 class LessonsControllerTest < ActionController::TestCase
-
+  include Devise::TestHelpers
   def setup
     @course = Course.find_by_name('Operation System')
+    @teacher = @course.teachers.first
   end
 
   # GET /course/1/lessons.json
@@ -22,8 +23,9 @@ class LessonsControllerTest < ActionController::TestCase
     assert_not_nil json['lesson']['name']
   end
 
-  # POSt /course/1/lessons.json
+  # POST /course/1/lessons.json
   test 'api should add lesson to course' do
+    sign_in @teacher
     assert_difference('Lesson.count') do
       post :create, format: :json, course_id: @course.id, lesson: {
                       name: 'test lesson',
diff --git a/test/controllers/semesters_controller_test.rb b/test/controllers/semesters_controller_test.rb
index 8017cf2..0588569 100644
--- a/test/controllers/semesters_controller_test.rb
+++ b/test/controllers/semesters_controller_test.rb
@@ -1,7 +1,7 @@
 require 'test_helper'
 
 class SemestersControllerTest < ActionController::TestCase
-
+  include Devise::TestHelpers
   # GET /semesters.json
   test 'should get all semesters' do
     get :index, format: :json
@@ -13,6 +13,9 @@ class SemestersControllerTest < ActionController::TestCase
 
   # POST /semesters.json
   test 'should add semester' do
+    admin = User.find_by_name('alex')
+    sign_in admin
+
     assert_difference 'Semester.count' do
       post :create, format: :json, semester: { name: 'a good semester' }
     end
@@ -22,6 +25,9 @@ class SemestersControllerTest < ActionController::TestCase
 
   # PUT /semesters/1.json
   test 'should update semester' do
+    admin = User.find_by_name('alex')
+    sign_in admin
+
     put :update, format: :json, id: Semester.first.id, semester: { name: 'update semester' }
     assert_equal 'update semester', Semester.first.name
 
@@ -30,6 +36,9 @@ class SemestersControllerTest < ActionController::TestCase
 
   # DELETE /semesters/1.json
   test 'should delete semester' do
+    admin = User.find_by_name('alex')
+    sign_in admin
+
     assert_difference 'Semester.count', -1 do
       delete :destroy, format: :json, id: Semester.first.id
     end
diff --git a/test/controllers/students_controller_test.rb b/test/controllers/students_controller_test.rb
index 1707937..cffabb3 100644
--- a/test/controllers/students_controller_test.rb
+++ b/test/controllers/students_controller_test.rb
@@ -1,8 +1,13 @@
 require 'test_helper'
 
 class StudentsControllerTest < ActionController::TestCase
+  include Devise::TestHelpers
+
   test 'api should get students by course' do
-    get :index, { format: :json, course_id: Course.find_by_name('Operation System').id }
+    course = Course.find_by_name('Operation System')
+    sign_in course.teachers.first
+
+    get :index, { format: :json, course_id: course.id }
 
     assert_json_success
     assert json['students'].is_a? Array
@@ -11,6 +16,7 @@ class StudentsControllerTest < ActionController::TestCase
   test 'api should add student by course' do
     course = Course.first
     student = User.last
+    sign_in student
 
     assert_difference 'Participation.count' do
       post :create, format: :json, course_id: course.id, id: student.id
-- 
1.9.1

