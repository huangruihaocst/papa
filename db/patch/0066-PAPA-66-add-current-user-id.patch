From 37b5c401bf01b91f845c10761b966e342e243311 Mon Sep 17 00:00:00 2001
From: Alex Wang <ice_b0und@hotmail.com>
Date: Sun, 11 Oct 2015 21:15:34 +0800
Subject: [PATCH 066/150] PAPA-66 add current user id

---
 README.md                             |  5 ++-
 app/controllers/courses_controller.rb | 65 ++++++++++++++++++++++-------------
 2 files changed, 45 insertions(+), 25 deletions(-)

diff --git a/README.md b/README.md
index 8cfc2fb..9304ee6 100644
--- a/README.md
+++ b/README.md
@@ -182,10 +182,13 @@ POST /users/sign_in.json     utf8=✓&user[login]=xxx&user[password]=123&user[re
     GET    /files/1.json             得到该文件的信息        "file": file
     POST   /files.json               上传文件                file parameters
     
+    # 用户相关
+    GET    /users/current.json       获取当前用户id          "id": "123"                                 Current User
+    
     
 Http Parameters/JSON对象格式
     
-    注意：奕semester举例,在URL中格式均为
+    注意：以semester举例,在URL中格式均为
     semester[name]=2009
     
     semester id=int
diff --git a/app/controllers/courses_controller.rb b/app/controllers/courses_controller.rb
index d1ac687..a2ae3dd 100644
--- a/app/controllers/courses_controller.rb
+++ b/app/controllers/courses_controller.rb
@@ -21,6 +21,9 @@ class CoursesController < ApplicationController
     case
       when params[:semester_id]
         @courses = Semester.find(params[:semester_id]).courses
+      when params[:teacher_id]
+        check_token(params[:token], params[:teacher_id], true)
+        @courses = User.find(params[:teacher_id]).teaching_courses
       when params[:student_id]
         check_token(params[:token], params[:student_id])
         @courses = Course.none
@@ -33,9 +36,6 @@ class CoursesController < ApplicationController
         User.find(params[@id_key]).participations.each do |participation|
           @courses <<= participation.course if ROLE_ASSISTANT == participation.role
         end
-      when params[:teacher_id]
-        check_token(params[:token], params[:teacher_id], true)
-        @courses = User.find(params[:teacher_id]).teaching_courses
       else
         json_failed
     end
@@ -51,30 +51,47 @@ class CoursesController < ApplicationController
     end
   end
 
-  # POST /semesters/courses.json
-  # POST /teachers/courses.json
-  # POST /assistants/courses.json
-  # POST /students/courses.json
+  # POST /semesters/1/courses.json
+  # POST /teachers/1/courses.json
+  # POST /assistants/1/courses/1.json
+  # POST /students/1/courses/1.json
   def create
-    course_create_params = params.require(:course).permit(:name, :description)
+    course_create_params = params.require(:course).permit(:name, :description, :semester_id)
 
-    case
-      when params[:semester_id]
-        Semester.find(params[:semester_id]).courses.create(course_create_params)
-      when params[:teacher_id]
-        check_token(params[:token], params[:teacher_id], true)
-
-      else
-        json_failed
-        return
-    end
-
-    respond_to do |format|
-      if @course.valid?
-        format.json { json_successful }
-      else
-        format.json { json_failed('invalid params') }
+    begin
+      case
+        when params[:teacher_id]
+          check_token(params[:token], params[:teacher_id], true)
+          if User.find(params[:teacher_id]).courses.create(course_create_params)
+            json_successful
+          else
+            json_failed
+          end
+        when params[:assistant_id] && params[:course_id]
+          check_token(params[:token], params[:assistant_id])
+          assistant = User.find(params[:assistant_id])
+          course = Course.find(params[:course_id])
+          assistant.courses << course
+          if assistant.save
+            json_successful
+          else
+            json_failed
+          end
+        when params[:student_id] && params[:course_id]
+          check_token(params[:token], params[:student_id])
+          student = User.find(params[:student_id])
+          course = Course.find(params[:course_id])
+          student.courses << course
+          if student.save
+            json_successful
+          else
+            json_failed
+          end
+        else
+          json_failed
       end
+    rescue
+      json_failed
     end
   end
 
-- 
1.9.1

