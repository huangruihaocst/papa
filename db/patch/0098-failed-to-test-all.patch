From 25a1ff54a496310332e385f4e0975a6c3408480b Mon Sep 17 00:00:00 2001
From: Alex Wang <ice_b0und@hotmail.com>
Date: Sat, 17 Oct 2015 17:16:25 +0800
Subject: [PATCH 098/150] failed to test all

---
 README.md                                          |  7 ++++
 app/controllers/files_controller.rb                | 37 ++++++++++++++++++++++
 app/models/course.rb                               | 18 ++++++++++-
 app/models/course_file.rb                          |  1 -
 app/models/student_file.rb                         |  1 +
 ...50930115150_add_lessons_studends_and_courses.rb |  3 +-
 db/schema.rb                                       |  3 +-
 test/controllers/files_controller_test.rb          |  2 ++
 8 files changed, 66 insertions(+), 6 deletions(-)

diff --git a/README.md b/README.md
index 6447154..81b3bcd 100644
--- a/README.md
+++ b/README.md
@@ -345,6 +345,13 @@ REASON_INVALID_OPERATION = 'invalid_operation' // 访问了不存在的url
     teaching_course id=int
             belongs_to user
             belongs_to course
+    learning_course id=int
+            belongs_to user
+            belongs_to course
+    assisting_course id=int
+            belongs_to user
+            belongs_to course
+            
     lesson_status id=int
             score=string
             belongs_to user
diff --git a/app/controllers/files_controller.rb b/app/controllers/files_controller.rb
index 89e974b..d9e7483 100644
--- a/app/controllers/files_controller.rb
+++ b/app/controllers/files_controller.rb
@@ -27,6 +27,9 @@ class FilesController < ApplicationController
   end
 
   # POST /files.json
+  # POST /students/1/files.json
+  # POST /courses/1/files.json
+  # POST /students/1/lessons/1/files.json
   def create
     user = check_login
 
@@ -50,9 +53,43 @@ class FilesController < ApplicationController
 
     @file = FileResource.create(file_type: p[:type], name: temp_file.original_filename, path: File.join('', rel_loc), creator_id: user.id)
     if @file.valid?
+      begin
+        if params[:student_id] && params[:lesson_id]
+          user = check_login
+          student = User.find(params[:student_id])
+          lesson = Lesson.find(params[:lesson_id])
+          if lesson.course.students.include? student
+            # student add a file to himself or assistant add a file to the student
+            if user == student || lesson.course.assistants.include?(user)
+              StudentFile.create(
+                  file_resource_id: @file.id,
+                  student_id:       student.id,
+                  lesson_id:        lesson.id,
+                  creator_id:       user.id
+              )
+            else
+              json_failed(REASON_PERMISSION_DENIED)
+            end
+          else
+            json_failed(REASON_PERMISSION_DENIED)
+          end
+        elsif params[:course_id]
+          user = check_teacher
+          course = Course.find(params[:course_id])
+          if course.teachers.include? user
+            CourseFile.create(file_resource_id: @file.id, course_id: course.id)
+          else
+            json_failed
+            return
+          end
+        end
+
         json_successful do |json|
           json['id'] = @file.id
         end
+      rescue ActiveRecord::RecordNotFound
+        json_failed
+      end
     else
       json_failed_invalid_fields(@file.errors.keys, file_type: :type, path: '', name: '')
     end
diff --git a/app/models/course.rb b/app/models/course.rb
index be0f601..a74f2d9 100644
--- a/app/models/course.rb
+++ b/app/models/course.rb
@@ -6,7 +6,7 @@ class Course < ActiveRecord::Base
   has_many :lessons
 
   has_many :participations
-  has_many :students, through: :participations, source: :user
+  has_many :participants, through: :participations, source: :user
 
   has_many :teaching_courses
   has_many :teachers, through: :teaching_courses, source: :user
@@ -15,4 +15,20 @@ class Course < ActiveRecord::Base
 
   has_many :course_files
   has_many :attached_files, through: :course_files, source: :file_resource
+
+  def students
+    users = User.none
+    participants.each do |p|
+      users <<= p if p.role == ROLE_STUDENT
+    end
+    users
+  end
+  def assistants
+    users = User.none
+    participants.each do |p|
+      users <<= p if p.role == ROLE_ASSISTANT
+    end
+    users
+  end
+
 end
diff --git a/app/models/course_file.rb b/app/models/course_file.rb
index 2dbad83..1b67f19 100644
--- a/app/models/course_file.rb
+++ b/app/models/course_file.rb
@@ -1,5 +1,4 @@
 class CourseFile < ActiveRecord::Base
   belongs_to :course
   belongs_to :file_resource
-  belongs_to :creator, class_name: 'User'
 end
\ No newline at end of file
diff --git a/app/models/student_file.rb b/app/models/student_file.rb
index 33c277a..f1eb0e7 100644
--- a/app/models/student_file.rb
+++ b/app/models/student_file.rb
@@ -1,4 +1,5 @@
 class StudentFile < ActiveRecord::Base
+  belongs_to :creator, class_name: 'User'
   belongs_to :student, class_name: 'User'
   belongs_to :lesson
   belongs_to :file_resource
diff --git a/db/migrate/20150930115150_add_lessons_studends_and_courses.rb b/db/migrate/20150930115150_add_lessons_studends_and_courses.rb
index 1dff349..8c87186 100644
--- a/db/migrate/20150930115150_add_lessons_studends_and_courses.rb
+++ b/db/migrate/20150930115150_add_lessons_studends_and_courses.rb
@@ -24,13 +24,11 @@ class AddLessonsStudendsAndCourses < ActiveRecord::Migration
 
     create_table :course_files do |t|
       t.integer :course_id
-      t.integer :creator_id
       t.integer :file_resource_id
     end
 
     create_table :lesson_files do |t|
       t.integer :lesson_id
-      t.integer :creator_id
       t.integer :file_resource_id
     end
 
@@ -38,6 +36,7 @@ class AddLessonsStudendsAndCourses < ActiveRecord::Migration
       t.integer :student_id
       t.integer :lesson_id
       t.integer :file_resource_id
+      t.integer :creator_id
     end
 
     create_table :assistant_files do |t|
diff --git a/db/schema.rb b/db/schema.rb
index 92bcff9..b0bd27a 100644
--- a/db/schema.rb
+++ b/db/schema.rb
@@ -28,7 +28,6 @@ ActiveRecord::Schema.define(version: 20151008120334) do
 
   create_table "course_files", force: :cascade do |t|
     t.integer "course_id"
-    t.integer "creator_id"
     t.integer "file_resource_id"
   end
 
@@ -60,7 +59,6 @@ ActiveRecord::Schema.define(version: 20151008120334) do
 
   create_table "lesson_files", force: :cascade do |t|
     t.integer "lesson_id"
-    t.integer "creator_id"
     t.integer "file_resource_id"
   end
 
@@ -118,6 +116,7 @@ ActiveRecord::Schema.define(version: 20151008120334) do
     t.integer "student_id"
     t.integer "lesson_id"
     t.integer "file_resource_id"
+    t.integer "creator_id"
   end
 
   create_table "teaching_courses", force: :cascade do |t|
diff --git a/test/controllers/files_controller_test.rb b/test/controllers/files_controller_test.rb
index f4569c7..99729cb 100644
--- a/test/controllers/files_controller_test.rb
+++ b/test/controllers/files_controller_test.rb
@@ -134,6 +134,8 @@ class FilesControllerTest < ActionController::TestCase
     File.delete(file_path)
   end
 
+  # POST /courses/1/files.json
+
   # DELETE /files/1.json
   test 'should delete file if he is the creator' do
     sign_in User.first
-- 
1.9.1

