From 1c42769a00aca08e8719442d002577d03001f340 Mon Sep 17 00:00:00 2001
From: Alex Wang <ice_b0und@hotmail.com>
Date: Sat, 24 Oct 2015 04:30:48 +0800
Subject: [PATCH 118/150] PAPA-138 fix get students bug

---
 README.md                                     |  9 ++++--
 app/controllers/assistants_controller.rb      |  3 --
 app/controllers/lessons_controller.rb         | 10 +++++--
 app/controllers/students_controller.rb        | 30 ++++++++++++++------
 test/controllers/courses_controller_test.rb   |  6 ++--
 test/controllers/files_controller_test.rb     |  2 ++
 test/controllers/lessons_controller_test.rb   | 21 +++++++++++++-
 test/controllers/messages_controller_test.rb  |  2 ++
 test/controllers/semesters_controller_test.rb |  3 ++
 test/controllers/students_controller_test.rb  | 40 ++++++++++++++++++++++++---
 test/controllers/teachers_controller_test.rb  |  2 ++
 test/controllers/users_controller_test.rb     | 24 ++++++++++++++++
 12 files changed, 127 insertions(+), 25 deletions(-)
 create mode 100644 test/controllers/users_controller_test.rb

diff --git a/README.md b/README.md
index 425e636..6e7b57e 100644
--- a/README.md
+++ b/README.md
@@ -154,7 +154,9 @@ Android客户端通过访问指定的URL获得一个JSON文件来访问数据库
         permission_denied: 不是该课程的老师
         invalid_fields: lesson参数无效
     ?DELETE /lessons/1.json          删掉实验课
-        暂时不检查错误
+        permisson_denied: 不是该课程的老师
+        resource_not_found: lesson_id不存在
+        internal_error: 其他内部错误, 如果遇到请联系我
     ?GET    /courses/1/comments.json  得到某门课程所有学生的所有评论                                      Teacher
         not_implemented(罗干要求)
     
@@ -186,6 +188,7 @@ Android客户端通过访问指定的URL获得一个JSON文件来访问数据库
     # namespace students
     # 学生相关
     GET    /students/1.json          获得id=1学生的信息   "student": [{"id":1, "name": "xx"}, ..]        Student
+        permisson_denied: 未登录
         resource_not_found: student_id不存在
     GET    /students/1/files.json    获得学生所有文件列表   "files": [{"id":1, "type": "jpg", "path": "xx"}...]  Student 
         permission_denied: 当前用户不是student_id
@@ -221,7 +224,7 @@ Android客户端通过访问指定的URL获得一个JSON文件来访问数据库
     POST   /students/1/lessons/1/files.json 在某门实验课上添加视频图片                                    Student
         permission_denied: 一下三条至少有一条不满足:
             1. 用户已经登陆或当前token有效
-            2. student_id包含在lesson_id对应的课程的学生名单中
+            2. student_id包含在lesson_id对应的课程的学生名单中 ***(或者当前用户是课程的老师)
             3. 当前用户是student_id或当前用户在lesson_id的助教名单中
         invalid_fields: file参数或type参数未指定或者格式不正确
         file_too_big: 文件大小超过指定大小(100M, 该数值请查看config/initializers/constants.rb)
@@ -246,7 +249,7 @@ Android客户端通过访问指定的URL获得一个JSON文件来访问数据库
         internal_error: 其他内部错误, 如果遇到请联系我
     GET    /assistants/1/files.json   助教上传的所有文件    "files": [file, ...]                         Assistant
         permission_denied: 当前用户和assistant_id不匹配
-        resource_not_found: lesson_id不存在
+        resource_not_found: assistant_id不存在
         
     # 老师相关
     GET    /teachers/1.json           获得某个老师的信息    "teacher": teacher                           Student
diff --git a/app/controllers/assistants_controller.rb b/app/controllers/assistants_controller.rb
index 2273bbd..9d0e141 100644
--- a/app/controllers/assistants_controller.rb
+++ b/app/controllers/assistants_controller.rb
@@ -2,9 +2,6 @@ class AssistantsController < ApplicationController
 
   before_action only: [:show] do
     set_assistant
-
-    raise TokenException.new(REASON_TOKEN_INVALID) unless @assistant
-    check_token(params[:token], @assistant.id)
   end
 
   def index
diff --git a/app/controllers/lessons_controller.rb b/app/controllers/lessons_controller.rb
index 73ab93f..15fd420 100644
--- a/app/controllers/lessons_controller.rb
+++ b/app/controllers/lessons_controller.rb
@@ -48,10 +48,14 @@ class LessonsController < ApplicationController
 
   # DELETE /lessons/1.json
   def destroy
-    if @lesson && @lesson.destroy
-      json_successful
+    if @lesson
+      if @lesson.destroy
+        json_successful
+      else
+        json_failed
+      end
     else
-      json_failed
+      json_failed(REASON_RESOURCE_NOT_FOUND)
     end
   end
 
diff --git a/app/controllers/students_controller.rb b/app/controllers/students_controller.rb
index 7c738d3..3e4c379 100644
--- a/app/controllers/students_controller.rb
+++ b/app/controllers/students_controller.rb
@@ -2,9 +2,6 @@ class StudentsController < ApplicationController
 
   before_action only: [:show] do
     set_student
-
-    raise TokenException.new(REASON_TOKEN_INVALID) unless @student
-    check_token(params[:token], @student.id)
   end
 
   # GET /lessons/1/students.json (sign in the lesson)
@@ -23,13 +20,16 @@ class StudentsController < ApplicationController
       rescue ActiveRecord::RecordNotFound
         json_failed(REASON_RESOURCE_NOT_FOUND)
       end
-    else
+    elsif params[:lesson_id]
       json_failed(REASON_NOT_IMPLEMENTED)
+    else
+      json_failed(REASON_INVALID_OPERATION)
     end
   end
 
   # GET /students/1.json
   def show
+    check_login
     begin
       @student = User.find(params[:id])
     rescue ActiveRecord::RecordNotFound
@@ -38,6 +38,7 @@ class StudentsController < ApplicationController
   end
 
   # POST /courses/1/students/1.json
+  # POST /lessons/1/students/1.json
   def create
     if params[:course_id] && params[:id]
       course =  Course.find(params[:course_id])
@@ -47,6 +48,8 @@ class StudentsController < ApplicationController
       else
         json_failed
       end
+    elsif params[:lesson_id] && param[:id]
+      json_failed(REASON_NOT_IMPLEMENTED)
     else
       json_failed
     end
@@ -55,10 +58,21 @@ class StudentsController < ApplicationController
   # DELETE /courses/1/students/1.json
   def destroy
     if params[:course_id] && params[:id]
-      if Participation.where(user_id: params[:id]).where(course_id: params[:course_id]).first.destroy
-        json_successful
-      else
-        json_failed
+      begin
+        course = Course.find(params[:course_id])
+        must_be_a_teacher_of(params[:token], course)
+        ps = Participation.where(user_id: params[:id]).where(course_id: params[:course_id])
+        if ps.count > 0
+          if ps.first.destroy
+            json_successful
+          else
+            json_failed
+          end
+        else
+          json_failed(REASON_RESOURCE_NOT_FOUND)
+        end
+      rescue ActiveRecord::RecordNotFound
+        json_failed(REASON_RESOURCE_NOT_FOUND)
       end
     else
       json_failed
diff --git a/test/controllers/courses_controller_test.rb b/test/controllers/courses_controller_test.rb
index 708e9f8..cfa366e 100644
--- a/test/controllers/courses_controller_test.rb
+++ b/test/controllers/courses_controller_test.rb
@@ -1,6 +1,9 @@
 require 'test_helper'
 
 class CoursesControllerTest < ActionController::TestCase
+  include Devise::TestHelpers
+
+  ## DONE
 
   # GET /semesters/1/courses.json
   test 'api should get courses by semester' do
@@ -143,9 +146,6 @@ class CoursesControllerTest < ActionController::TestCase
 
   # DELETE /courses/1.json
   test 'api should delete course by id with teacher token' do
-    u = User.find_by_name('alex')
-    token_str = u.create_token.token
-
     course = Course.find_by_name('Operation System')
     teacher = course.teachers.first
     token_str = teacher.create_token.token
diff --git a/test/controllers/files_controller_test.rb b/test/controllers/files_controller_test.rb
index e950bf2..a9de175 100644
--- a/test/controllers/files_controller_test.rb
+++ b/test/controllers/files_controller_test.rb
@@ -3,6 +3,8 @@ require 'test_helper'
 class FilesControllerTest < ActionController::TestCase
   include Devise::TestHelpers
 
+  ## DONE
+
   # GET /students/1/lessons/1/files.json
   test 'should get student files on lesson' do
     student = User.find_by_name('betty')
diff --git a/test/controllers/lessons_controller_test.rb b/test/controllers/lessons_controller_test.rb
index 705eb62..fb59777 100644
--- a/test/controllers/lessons_controller_test.rb
+++ b/test/controllers/lessons_controller_test.rb
@@ -2,6 +2,9 @@ require 'test_helper'
 
 class LessonsControllerTest < ActionController::TestCase
   include Devise::TestHelpers
+
+  # DONE
+
   def setup
     @course = Course.find_by_name('Operation System')
     @teacher = @course.teachers.first
@@ -47,8 +50,24 @@ class LessonsControllerTest < ActionController::TestCase
 
   # DELETE /lessons/1.json
   test 'should delete lesson by id' do
+    teacher = @course.teachers.first
+    lesson = @course.lessons.first
+    sign_in teacher
+
+    assert_difference 'Lesson.count', -1 do
+      delete :destroy, format: :json, id: lesson.id
+    end
+
+    assert_json_success
+  end
+
+  test 'should not delete lesson by id if he is not a teacher of the lesson' do
+    teacher = User.find_by_name('betty')
+    lesson = @course.lessons.first
+    sign_in teacher
+
     assert_difference 'Lesson.count', -1 do
-      delete :destroy, format: :json, id: Lesson.first.id
+      delete :destroy, format: :json, id: lesson.id
     end
 
     assert_json_success
diff --git a/test/controllers/messages_controller_test.rb b/test/controllers/messages_controller_test.rb
index 7be710f..0fba348 100644
--- a/test/controllers/messages_controller_test.rb
+++ b/test/controllers/messages_controller_test.rb
@@ -3,6 +3,8 @@ require 'test_helper'
 class MessagesControllerTest < ActionController::TestCase
   include Devise::TestHelpers
 
+  ## DONE
+
   # GET /students/1/messages.json
   test 'should get message by student' do
     student = User.find_by_name('alex')
diff --git a/test/controllers/semesters_controller_test.rb b/test/controllers/semesters_controller_test.rb
index 0588569..1631676 100644
--- a/test/controllers/semesters_controller_test.rb
+++ b/test/controllers/semesters_controller_test.rb
@@ -2,6 +2,9 @@ require 'test_helper'
 
 class SemestersControllerTest < ActionController::TestCase
   include Devise::TestHelpers
+
+  ## DONE
+
   # GET /semesters.json
   test 'should get all semesters' do
     get :index, format: :json
diff --git a/test/controllers/students_controller_test.rb b/test/controllers/students_controller_test.rb
index cffabb3..5a484b0 100644
--- a/test/controllers/students_controller_test.rb
+++ b/test/controllers/students_controller_test.rb
@@ -3,7 +3,10 @@ require 'test_helper'
 class StudentsControllerTest < ActionController::TestCase
   include Devise::TestHelpers
 
-  test 'api should get students by course' do
+  ## DONE but student 'sign in'
+
+  # GET /courses/1/students.json
+  test 'should get students by course' do
     course = Course.find_by_name('Operation System')
     sign_in course.teachers.first
 
@@ -13,10 +16,21 @@ class StudentsControllerTest < ActionController::TestCase
     assert json['students'].is_a? Array
   end
 
-  test 'api should add student by course' do
+  # GET /courses/1/students.json
+  test 'should not get students by invalid course id' do
+    sign_in Course.first.teachers.first
+    get :index, { format: :json, course_id: -1 }
+
+    assert_equal STATUS_FAIL, json['status']
+    assert_equal REASON_RESOURCE_NOT_FOUND, json['reason']
+  end
+
+  # POST /courses/1/students/1.json
+  test 'should add student by course' do
     course = Course.first
+    teacher = course.teachers.first
     student = User.last
-    sign_in student
+    sign_in teacher
 
     assert_difference 'Participation.count' do
       post :create, format: :json, course_id: course.id, id: student.id
@@ -25,10 +39,14 @@ class StudentsControllerTest < ActionController::TestCase
     assert_json_success
   end
 
-  test 'api should remove student from course' do
+  # DELETE /courses/1/students/1.json
+  test 'should remove student from course' do
     course = Participation.first.course
+    teacher = course.teachers.first
     student = Participation.first.user
 
+    sign_in teacher
+
     assert_difference 'Participation.count', -1 do
       delete :destroy, format: :json, course_id: course.id, id: student.id
     end
@@ -36,4 +54,18 @@ class StudentsControllerTest < ActionController::TestCase
     assert_json_success
   end
 
+  # DELETE /courses/1/students/1.json
+  test 'should not remove student from course if not a teacher of the course' do
+    course = Participation.first.course
+    teacher = User.find_by_name('betty')
+    student = Participation.first.user
+
+    sign_in teacher
+
+    assert_no_difference 'Participation.count' do
+      delete :destroy, format: :json, course_id: course.id, id: student.id
+    end
+    assert_equal STATUS_FAIL, json['status']
+  end
+
 end
diff --git a/test/controllers/teachers_controller_test.rb b/test/controllers/teachers_controller_test.rb
index 99cd772..14a4fa7 100644
--- a/test/controllers/teachers_controller_test.rb
+++ b/test/controllers/teachers_controller_test.rb
@@ -3,6 +3,8 @@ require 'test_helper'
 class TeachersControllerTest < ActionController::TestCase
   include Devise::TestHelpers
 
+  ## DONE except update
+
   # GET /courses/1/teachers.json
   test 'should get teachers by course' do
     get :index, format: :json, course_id: Course.find_by_name('Operation System').id
diff --git a/test/controllers/users_controller_test.rb b/test/controllers/users_controller_test.rb
new file mode 100644
index 0000000..f163603
--- /dev/null
+++ b/test/controllers/users_controller_test.rb
@@ -0,0 +1,24 @@
+require 'test_helper'
+
+class UsersControllerTest < ActionController::TestCase
+  include Devise::TestHelpers
+
+  ## DONE
+
+  # GET /users/current.json
+  test 'should get current user' do
+    user = User.first
+    sign_in user
+
+    get :current, format: :json
+    assert_json_success
+    assert_equal json['id'].to_i, user.id
+  end
+
+  # GET /users/current.json
+  test 'should not get current user if not signed in' do
+    get :current, format: :json
+    assert_equal STATUS_FAIL, json['status']
+  end
+
+end
-- 
1.9.1

