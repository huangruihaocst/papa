From 98a8817bb92214b648e6b9a05ca6b8d8875c36f8 Mon Sep 17 00:00:00 2001
From: Alex Wang <ice_b0und@hotmail.com>
Date: Thu, 8 Oct 2015 19:32:04 +0800
Subject: [PATCH 036/150] fix student and course relationship bugs

---
 README.md                                                  |  4 +++-
 app/controllers/courses_controller.rb                      | 12 +++++++++++-
 app/controllers/students_controller.rb                     |  7 ++++---
 app/views/courses/index.json.jbuilder                      |  1 +
 config/initializers/constants.rb                           |  3 ++-
 config/routes.rb                                           |  7 ++++---
 db/init_data/db.rb                                         |  6 ++++++
 db/migrate/20150926114146_devise_create_users.rb           |  2 +-
 .../20150930115150_add_lessons_studends_and_courses.rb     |  2 +-
 db/schema.rb                                               | 14 +++++++-------
 db/seeds.rb                                                |  1 +
 11 files changed, 41 insertions(+), 18 deletions(-)

diff --git a/README.md b/README.md
index 94b96ea..0eb7466 100644
--- a/README.md
+++ b/README.md
@@ -26,6 +26,7 @@ or visit [rvm.io](http://rvm.io)
     
 #### 3. Configure project and database.
     #!/bin/sh
+    gem install bundler
     bundle install
     rake db:migrate
     rake db:seed
@@ -33,6 +34,7 @@ or visit [rvm.io](http://rvm.io)
 For production, use:
 
     #!/bin/sh
+    gem install bundler
     bundle install
     rake db:migrate RAILS_ENV=production
     rake db:seed RAILS_ENV=production
@@ -71,7 +73,7 @@ Android客户端通过访问指定的URL获得一个JSON文件来访问数据库
 ###各个URL对应JSON文件格式, 以及各个URL功能简介
 
     标记方法：
-    HTTP方法 URL              功能             JSON格式(GET)/URL参数(POST/UPDATE/DELETE)
+    HTTP方法 URL                      功能                JSON格式(GET)/URL参数(POST/UPDATE/DELETE)
         
     
     列表：
diff --git a/app/controllers/courses_controller.rb b/app/controllers/courses_controller.rb
index 9c1386d..f751a1b 100644
--- a/app/controllers/courses_controller.rb
+++ b/app/controllers/courses_controller.rb
@@ -5,7 +5,15 @@ class CoursesController < ApplicationController
   # GET /courses
   # GET /courses.json
   def index
-    @courses = Course.all
+    if params[:student_id]
+      @courses = Course.none
+      User.find(params[:student_id]).participations.each do |participation|
+        @courses <<= participation.course
+      end
+    else
+      @courses = Course.all
+    end
+
   end
 
   # GET /courses/1
@@ -42,4 +50,6 @@ class CoursesController < ApplicationController
     end
   end
 
+
+
 end
diff --git a/app/controllers/students_controller.rb b/app/controllers/students_controller.rb
index 9eced0d..96273dc 100644
--- a/app/controllers/students_controller.rb
+++ b/app/controllers/students_controller.rb
@@ -3,11 +3,11 @@ class StudentsController < ApplicationController
   before_action :set_student, only: [:show]
 
   def index
-    course = Course.find(params[:course_id])
+    course = Course.find(params[:course_id] || 1)
     participations = course.participations.where(role: ROLE_STUDENT)
     @students = User.none
     participations.each do |p|
-      @students << p.student
+      @students <<= p.user
     end
   end
 
@@ -23,7 +23,8 @@ class StudentsController < ApplicationController
   def set_student
     begin
       student = User.find(params[:id])
-      @participation = student.participations.where(course_id: params[:course_id])
+      ### just for debug, default course_id is 1
+      @participation = student.participations.where(course_id: params[:course_id] || 1).first
       if @participation.role == ROLE_STUDENT
         @student = student
       else
diff --git a/app/views/courses/index.json.jbuilder b/app/views/courses/index.json.jbuilder
index d5855fd..bb9bae9 100644
--- a/app/views/courses/index.json.jbuilder
+++ b/app/views/courses/index.json.jbuilder
@@ -3,6 +3,7 @@ json.status STATUS_SUCCESS
 json.courses do
   json.array!(@courses) do |course|
     json.extract! course, :id
+    json.extract! course, :name
   end
 end
 
diff --git a/config/initializers/constants.rb b/config/initializers/constants.rb
index ad4f13d..66cacea 100644
--- a/config/initializers/constants.rb
+++ b/config/initializers/constants.rb
@@ -1,4 +1,5 @@
 
 ROLE_STUDENT = 'student'
+ROLE_ASSISTANT = 'assistant'
 STATUS_SUCCESS = 'successful'
-STATUS_FAIL = 'failed'
\ No newline at end of file
+STATUS_FAIL = 'failed'
diff --git a/config/routes.rb b/config/routes.rb
index c1a0c88..8f87fa8 100644
--- a/config/routes.rb
+++ b/config/routes.rb
@@ -5,6 +5,10 @@ Rails.application.routes.draw do
   resources :courses do
     resources :students
   end
+  resources :students do
+    resources :courses
+  end
+  resources :lessons
   # The priority is based upon order of creation: first created -> highest priority.
   # See how all your routes lay out with "rake routes".
 
@@ -52,7 +56,4 @@ Rails.application.routes.draw do
   #       get 'recent', on: :collection
   #     end
   #   end
-
-  resources :lessons
-
 end
diff --git a/db/init_data/db.rb b/db/init_data/db.rb
index e69de29..cb55414 100644
--- a/db/init_data/db.rb
+++ b/db/init_data/db.rb
@@ -0,0 +1,6 @@
+c = Course.create(name: 'os', description: '123')
+u = User.create(name:'alex', phone:'123', email:'a@b.c', password:'123', password_confirmation:'123')
+p = Participation.create(user_id: u.id, course_id: c.id)
+u.participations << p
+u.save
+
diff --git a/db/migrate/20150926114146_devise_create_users.rb b/db/migrate/20150926114146_devise_create_users.rb
index b59661f..40cb06f 100644
--- a/db/migrate/20150926114146_devise_create_users.rb
+++ b/db/migrate/20150926114146_devise_create_users.rb
@@ -21,7 +21,7 @@ class DeviseCreateUsers < ActiveRecord::Migration
       t.string   :current_sign_in_ip
       t.string   :last_sign_in_ip
 
-      t.boolean  :is_teacher
+      t.boolean  :is_teacher, default: true
 
       t.timestamps null: false
     end
diff --git a/db/migrate/20150930115150_add_lessons_studends_and_courses.rb b/db/migrate/20150930115150_add_lessons_studends_and_courses.rb
index eff16c5..e2bd5cf 100644
--- a/db/migrate/20150930115150_add_lessons_studends_and_courses.rb
+++ b/db/migrate/20150930115150_add_lessons_studends_and_courses.rb
@@ -18,7 +18,7 @@ class AddLessonsStudendsAndCourses < ActiveRecord::Migration
     create_table :participations do |t|
       t.integer :course_id
       t.integer :user_id
-      t.string  :role # student/assitant
+      t.string  :role, default: ROLE_STUDENT # student/assitant
     end
 
   end
diff --git a/db/schema.rb b/db/schema.rb
index 41a9cef..61784be 100644
--- a/db/schema.rb
+++ b/db/schema.rb
@@ -30,25 +30,25 @@ ActiveRecord::Schema.define(version: 20150930115150) do
   create_table "participations", force: :cascade do |t|
     t.integer "course_id"
     t.integer "user_id"
-    t.string  "role"
+    t.string  "role",      default: "student"
   end
 
   create_table "users", force: :cascade do |t|
     t.string   "name",                   default: ""
     t.string   "phone"
-    t.string   "email",                  default: "", null: false
-    t.string   "encrypted_password",     default: "", null: false
+    t.string   "email",                  default: "",   null: false
+    t.string   "encrypted_password",     default: "",   null: false
     t.string   "reset_password_token"
     t.datetime "reset_password_sent_at"
     t.datetime "remember_created_at"
-    t.integer  "sign_in_count",          default: 0,  null: false
+    t.integer  "sign_in_count",          default: 0,    null: false
     t.datetime "current_sign_in_at"
     t.datetime "last_sign_in_at"
     t.string   "current_sign_in_ip"
     t.string   "last_sign_in_ip"
-    t.boolean  "is_teacher"
-    t.datetime "created_at",                          null: false
-    t.datetime "updated_at",                          null: false
+    t.boolean  "is_teacher",             default: true
+    t.datetime "created_at",                            null: false
+    t.datetime "updated_at",                            null: false
   end
 
   add_index "users", ["email"], name: "index_users_on_email", unique: true
diff --git a/db/seeds.rb b/db/seeds.rb
index 4edb1e8..934c2fa 100644
--- a/db/seeds.rb
+++ b/db/seeds.rb
@@ -5,3 +5,4 @@
 #
 #   cities = City.create([{ name: 'Chicago' }, { name: 'Copenhagen' }])
 #   Mayor.create(name: 'Emanuel', city: cities.first)
+require './db/init_data/db'
\ No newline at end of file
-- 
1.9.1

