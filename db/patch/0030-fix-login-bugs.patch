From 43b14aa5682667fc330706ec8f558c0b1dbcc625 Mon Sep 17 00:00:00 2001
From: Alex Wang <ice_b0und@hotmail.com>
Date: Wed, 7 Oct 2015 14:42:01 +0800
Subject: [PATCH 030/150] fix login bugs

---
 app/models/user.rb                               | 20 ++++++++++++++++++++
 app/views/devise/sessions/new.html.erb           |  4 ++--
 config/initializers/devise.rb                    |  2 +-
 db/migrate/20150926114146_devise_create_users.rb |  6 +++---
 test/fixtures/users.yml                          |  8 ++++++--
 5 files changed, 32 insertions(+), 8 deletions(-)

diff --git a/app/models/user.rb b/app/models/user.rb
index a8687bc..66ceed5 100644
--- a/app/models/user.rb
+++ b/app/models/user.rb
@@ -7,4 +7,24 @@ class User < ActiveRecord::Base
 
   has_many :participations
   has_many :courses, through: :participations
+
+  # the following 4 methods allow us to login with phone or email
+  def login=(login)
+    @login = login
+  end
+  def login
+    @login || self.phone || self.email
+  end
+  def self.find_for_database_authentication(warden_conditions)
+    conditions = warden_conditions.dup
+    if login = conditions.delete(:login)
+      where(conditions.to_hash).where(["lower(phone) = :value OR lower(email) = :value", { :value => login.downcase }]).first
+    else
+      where(conditions.to_hash).first
+    end
+  end
+  def email_required?
+    false
+  end
+
 end
diff --git a/app/views/devise/sessions/new.html.erb b/app/views/devise/sessions/new.html.erb
index b261cfd..9e338c2 100644
--- a/app/views/devise/sessions/new.html.erb
+++ b/app/views/devise/sessions/new.html.erb
@@ -2,8 +2,8 @@
 
 <%= form_for(resource, as: resource_name, url: session_path(resource_name)) do |f| %>
   <div class="field">
-    <%= f.label :email %><br />
-    <%= f.email_field :email, autofocus: true %>
+    <%= f.label :email_or_phone %><br />
+    <%= f.text_field :login, autofocus: true %>
   </div>
 
   <div class="field">
diff --git a/config/initializers/devise.rb b/config/initializers/devise.rb
index c6cd874..5952e34 100644
--- a/config/initializers/devise.rb
+++ b/config/initializers/devise.rb
@@ -31,7 +31,7 @@ Devise.setup do |config|
   # session. If you need permissions, you should implement that in a before filter.
   # You can also supply a hash where the value is a boolean determining whether
   # or not authentication should be aborted when the value is not present.
-  config.authentication_keys = [:email]
+  config.authentication_keys = [:login]
 
   # Configure parameters from the request object used for authentication. Each entry
   # given should be a request method and it will automatically be passed to the
diff --git a/db/migrate/20150926114146_devise_create_users.rb b/db/migrate/20150926114146_devise_create_users.rb
index da3e030..1968db7 100644
--- a/db/migrate/20150926114146_devise_create_users.rb
+++ b/db/migrate/20150926114146_devise_create_users.rb
@@ -2,8 +2,8 @@ class DeviseCreateUsers < ActiveRecord::Migration
   def change
     create_table(:users) do |t|
       ## Database authenticatable
-      t.string :name,               null: false, default: ""
-      t.string :phone,              null: false, default: ""
+      t.string :name,               null: true, default: ""
+      t.string :phone,              null: true, default: ""
       t.string :email,              null: false, default: ""
       t.string :encrypted_password, null: false, default: ""
 
@@ -26,7 +26,7 @@ class DeviseCreateUsers < ActiveRecord::Migration
       t.timestamps null: false
     end
 
-    add_index :users, :phone,                unique: true
+    #add_index :users, :phone,                unique: true
     add_index :users, :email,                unique: true
     add_index :users, :reset_password_token, unique: true
     # add_index :users, :confirmation_token,   unique: true
diff --git a/test/fixtures/users.yml b/test/fixtures/users.yml
index 2745feb..05cc1b8 100644
--- a/test/fixtures/users.yml
+++ b/test/fixtures/users.yml
@@ -1,9 +1,13 @@
 alex:
   name: 'alex'
   phone: '123'
-  email: 'a@b.c'
+  email: 'alex@b.c'
+  encrypted_password: <%= User.new.send(:password_digest, '123') %>
+  is_teacher: true
 
 betty:
   name: 'betty'
   phone: '122'
-  email: 'c@d.c'
\ No newline at end of file
+  email: 'betty@b.c'
+  encrypted_password: <%= User.new.send(:password_digest, '123') %>
+  is_teacher: false
-- 
1.9.1

