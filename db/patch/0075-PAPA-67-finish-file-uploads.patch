From d553de41be708414d1a0633c0a50a16a1d097aff Mon Sep 17 00:00:00 2001
From: Alex Wang <ice_b0und@hotmail.com>
Date: Wed, 14 Oct 2015 22:31:19 +0800
Subject: [PATCH 075/150] PAPA-67 finish file uploads

---
 README.md                                             |  2 +-
 app/controllers/courses_controller.rb                 |  9 +++++----
 app/controllers/files_controller.rb                   | 13 ++++++++++++-
 app/controllers/students_controller.rb                | 19 ++++++++++++-------
 ...20150930115150_add_lessons_studends_and_courses.rb |  2 +-
 db/schema.rb                                          |  2 +-
 test/controllers/lessons_controller_test.rb           |  7 ++++++-
 test/controllers/semesters_controller_test.rb         |  6 ++++++
 8 files changed, 44 insertions(+), 16 deletions(-)

diff --git a/README.md b/README.md
index c05fd07..ef753b7 100644
--- a/README.md
+++ b/README.md
@@ -147,7 +147,7 @@ POST /users/sign_in.json     utf8=✓&user[login]=xxx&user[password]=123&user[re
     
     # namespace students
     # 学生相关
-    GET    /students.json            获得（默认课程的）所有学生     "students": [{"id":1, "name": "xx"..] 
+    #GET    /students.json            获得（默认课程的）所有学生     "students": [{"id":1, "name": "xx"..] 
     GET    /students/1.json          获得id=1学生的信息   "student": [{"id":1, "name": "xx"}, ..]       Student
     #!POST   /students.json            添加一个学生         student parameters                            Teacher
     #!PUT    /students/1.json          修改学生             student parameters                            Student
diff --git a/app/controllers/courses_controller.rb b/app/controllers/courses_controller.rb
index 6b49bc5..7a8ba60 100644
--- a/app/controllers/courses_controller.rb
+++ b/app/controllers/courses_controller.rb
@@ -1,6 +1,6 @@
 class CoursesController < ApplicationController
 
-  before_action :set_course, only: [:show, :destroy]
+  before_action :set_course, only: [:show, :update, :destroy]
 
   # GET /semesters/1/courses.json
   # GET /students/1/courses.json
@@ -85,7 +85,8 @@ class CoursesController < ApplicationController
 
   # PUT /courses/1.json
   def update
-    if Course.find(params[:id]).update(params.require(:course).permit(:name, :description, :semester_id))
+    must_by_a_teacher_of(@course)
+    if @course.update(params.require(:course).permit(:name, :description, :semester_id))
       json_successful
     else
       json_failed
@@ -96,7 +97,7 @@ class CoursesController < ApplicationController
   # DELETE /students/1/courses/1.json
   # DELETE /assistants/1/courses/1.json
   def destroy
-    must_by_teacher_of(@course)
+    must_by_a_teacher_of(@course)
     case
       when params[:student_id]
         if Participation.where(user_id: params[:student_id], course_id: @course.id, role: ROLE_STUDENT).first.destroy
@@ -130,7 +131,7 @@ class CoursesController < ApplicationController
     end
   end
 
-  def must_by_teacher_of(course)
+  def must_by_a_teacher_of(course)
     raise TokenException.new(REASON_TOKEN_INVALID) unless course && course.is_a?(Course)
 
     if params[:token]
diff --git a/app/controllers/files_controller.rb b/app/controllers/files_controller.rb
index dffa1d9..c6b9070 100644
--- a/app/controllers/files_controller.rb
+++ b/app/controllers/files_controller.rb
@@ -23,8 +23,19 @@ class FilesController < ApplicationController
     @file = FileResource.find(params[:id])
   end
 
+  # POST /files.json
   def create
-    json_failed(REASON_NOT_IMPLEMENTED)
+    temp = params['file']
+    loc = Rails.root.join('public', 'uploads', temp.original_filename)
+    File.open(loc, 'wb') do |file|
+      file.write(temp.read)
+    end
+
+    if FileResource.create(file_type: params[:type], name: temp.original_filename, path: loc)
+      json_successful
+    else
+      json_failed
+    end
   end
 
   def destroy
diff --git a/app/controllers/students_controller.rb b/app/controllers/students_controller.rb
index 307fd99..34b9daa 100644
--- a/app/controllers/students_controller.rb
+++ b/app/controllers/students_controller.rb
@@ -7,15 +7,20 @@ class StudentsController < ApplicationController
     check_token(params[:token], @student.id)
   end
 
-  # GET /lessons/1/students.json
-  # GET /courses/1/students.json
+  # GET /lessons/1/students.json (sign in the lesson)
+  # GET /courses/1/students.json (student list of the course)
   def index
-    course = Course.find(params[:course_id] || 1)
-    participations = course.participations.where(role: ROLE_STUDENT)
-    @students = User.none
-    participations.each do |p|
-      @students <<= p.user
+    if params[:course_id]
+      course = Course.find(params[:course_id])
+      participations = course.participations.where(role: ROLE_STUDENT)
+      @students = User.none
+      participations.each do |p|
+        @students <<= p.user
+      end
+    else
+
     end
+
   end
 
   # GET /students/1.json
diff --git a/db/migrate/20150930115150_add_lessons_studends_and_courses.rb b/db/migrate/20150930115150_add_lessons_studends_and_courses.rb
index 5e4424f..1dff349 100644
--- a/db/migrate/20150930115150_add_lessons_studends_and_courses.rb
+++ b/db/migrate/20150930115150_add_lessons_studends_and_courses.rb
@@ -92,7 +92,7 @@ class AddLessonsStudendsAndCourses < ActiveRecord::Migration
     end
 
     create_table :file_resources do |t|
-      t.string :type
+      t.string :file_type
       t.string :name
       t.string :path
       t.integer :creator_id
diff --git a/db/schema.rb b/db/schema.rb
index 16f4b0b..3fa3f00 100644
--- a/db/schema.rb
+++ b/db/schema.rb
@@ -41,7 +41,7 @@ ActiveRecord::Schema.define(version: 20151008120334) do
   end
 
   create_table "file_resources", force: :cascade do |t|
-    t.string   "type"
+    t.string   "file_type"
     t.string   "name"
     t.string   "path"
     t.integer  "creator_id"
diff --git a/test/controllers/lessons_controller_test.rb b/test/controllers/lessons_controller_test.rb
index bcec0c4..fd541ad 100644
--- a/test/controllers/lessons_controller_test.rb
+++ b/test/controllers/lessons_controller_test.rb
@@ -6,6 +6,7 @@ class LessonsControllerTest < ActionController::TestCase
     @course = Course.find_by_name('Operation System')
   end
 
+  # GET /course/1/lessons.json
   test 'api should get all lessons by course' do
     get :index, format: :json, course_id: @course.id
     json = JSON.parse(@response.body)
@@ -13,6 +14,7 @@ class LessonsControllerTest < ActionController::TestCase
     assert json['lessons'].count > 0
   end
 
+  # GET /lessons/1.json
   test 'api should get lesson by id' do
     get :show, format: :json, id: Lesson.first.id
     json = JSON.parse(@response.body)
@@ -20,7 +22,8 @@ class LessonsControllerTest < ActionController::TestCase
     assert_not_nil json['lesson']['name']
   end
 
-  test 'api should add lesson' do
+  # POSt /course/1/lessons.json
+  test 'api should add lesson to course' do
     assert_difference('Lesson.count') do
       post :create, format: :json, course_id: @course.id, lesson: {
                       name: 'test lesson',
@@ -32,6 +35,7 @@ class LessonsControllerTest < ActionController::TestCase
     assert_equal JSON.parse(@response.body)['status'], STATUS_SUCCESS
   end
 
+  # POST /courses/1/lessons.json
   test 'api should not add bad lesson' do
     assert_no_difference('Lesson.count') do
       post :create, format: :json, course_id: @course.id, lesson: { bad_name: 'bad name' }
@@ -39,6 +43,7 @@ class LessonsControllerTest < ActionController::TestCase
     assert_equal JSON.parse(@response.body)['status'], STATUS_FAIL
   end
 
+  # DELETE /lessons/1.json
   test 'should delete lesson by id' do
     assert_difference 'Lesson.count', -1 do
       delete :destroy, format: :json, id: Lesson.first.id
diff --git a/test/controllers/semesters_controller_test.rb b/test/controllers/semesters_controller_test.rb
index 38967d8..a07c64f 100644
--- a/test/controllers/semesters_controller_test.rb
+++ b/test/controllers/semesters_controller_test.rb
@@ -1,6 +1,8 @@
 require 'test_helper'
 
 class SemestersControllerTest < ActionController::TestCase
+
+  # GET /semesters.json
   test 'should get all semesters' do
     get :index, format: :json
     json = JSON.parse(response.body)
@@ -9,6 +11,7 @@ class SemestersControllerTest < ActionController::TestCase
     assert json['semesters'].count > 0
   end
 
+  # POST /semesters.json
   test 'should add semester' do
     assert_difference 'Semester.count' do
       post :create, format: :json, semester: { name: 'a good semester' }
@@ -17,6 +20,7 @@ class SemestersControllerTest < ActionController::TestCase
     assert_equal STATUS_SUCCESS, json['status']
   end
 
+  # PUT /semesters/1.json
   test 'should update semester' do
     put :update, format: :json, id: Semester.first.id, semester: { name: 'update semester' }
     assert_equal 'update semester', Semester.first.name
@@ -24,6 +28,7 @@ class SemestersControllerTest < ActionController::TestCase
     assert_equal STATUS_SUCCESS, json['status']
   end
 
+  # DELETE /semesters/1.json
   test 'should delete semester' do
     assert_difference 'Semester.count', -1 do
       delete :destroy, format: :json, id: Semester.first.id
@@ -32,6 +37,7 @@ class SemestersControllerTest < ActionController::TestCase
     assert_equal STATUS_SUCCESS, json['status']
   end
 
+  # GET /semesters/default.json
   test 'should get default semester' do
     get :default, format: :json
     json = JSON.parse(response.body)
-- 
1.9.1

