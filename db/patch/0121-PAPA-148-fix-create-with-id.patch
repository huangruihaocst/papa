From d325fb2bab3c495a609ca69412f258df69f1a8e3 Mon Sep 17 00:00:00 2001
From: Alex Wang <ice_b0und@hotmail.com>
Date: Fri, 23 Oct 2015 16:33:14 +0800
Subject: [PATCH 121/150] PAPA-148 fix create with id

---
 app/controllers/courses_controller.rb          | 2 +-
 app/controllers/files_controller.rb            | 4 +---
 app/controllers/lesson_comments_controller.rb  | 5 +++--
 app/controllers/lessons_controller.rb          | 2 +-
 app/controllers/messages_controller.rb         | 2 +-
 app/controllers/semesters_controller.rb        | 5 +++--
 app/controllers/student_comments_controller.rb | 3 ++-
 app/helpers/application_helper.rb              | 4 ++--
 8 files changed, 14 insertions(+), 13 deletions(-)

diff --git a/app/controllers/courses_controller.rb b/app/controllers/courses_controller.rb
index f0eb177..3310113 100644
--- a/app/controllers/courses_controller.rb
+++ b/app/controllers/courses_controller.rb
@@ -53,7 +53,7 @@ class CoursesController < ApplicationController
           teacher = User.find(params[:teacher_id])
           course = Course.create(course_create_params)
           if teacher.teaching_courses.create(course_id: course.id)
-            json_successful
+            json_successful(id: course.id)
           else
             json_failed
           end
diff --git a/app/controllers/files_controller.rb b/app/controllers/files_controller.rb
index 147fe47..1096255 100644
--- a/app/controllers/files_controller.rb
+++ b/app/controllers/files_controller.rb
@@ -94,9 +94,7 @@ class FilesController < ApplicationController
           end
         end
 
-        json_successful do |json|
-          json['id'] = @file.id
-        end
+        json_successful(id: @file.id)
       rescue ActiveRecord::RecordNotFound
         @file.destroy
         json_failed(REASON_RESOURCE_NOT_FOUND)
diff --git a/app/controllers/lesson_comments_controller.rb b/app/controllers/lesson_comments_controller.rb
index 5e65eaa..ff78b9a 100644
--- a/app/controllers/lesson_comments_controller.rb
+++ b/app/controllers/lesson_comments_controller.rb
@@ -14,8 +14,9 @@ class LessonCommentsController < ApplicationController
   def create
     if check_current_user_student_of_lesson(params[:lesson_id])
       lesson = Lesson.find(params[:lesson_id])
-      if lesson.lesson_comments.create(params.require(:lesson_comment).permit(:content, :score))
-        json_successful
+      comment = lesson.lesson_comments.create(params.require(:lesson_comment).permit(:content, :score))
+      if comment
+        json_successful(id: comment.id)
       else
         json_failed
       end
diff --git a/app/controllers/lessons_controller.rb b/app/controllers/lessons_controller.rb
index 15fd420..5b2dd31 100644
--- a/app/controllers/lessons_controller.rb
+++ b/app/controllers/lessons_controller.rb
@@ -40,7 +40,7 @@ class LessonsController < ApplicationController
             merge({ course_id: params[:course_id] }))
 
     if @lesson.valid?
-      json_successful
+      json_successful(id: @lesson.id)
     else
       json_failed(REASON_INVALID_FIELD)
     end
diff --git a/app/controllers/messages_controller.rb b/app/controllers/messages_controller.rb
index ed45465..2aebf42 100644
--- a/app/controllers/messages_controller.rb
+++ b/app/controllers/messages_controller.rb
@@ -47,7 +47,7 @@ class MessagesController < ApplicationController
     )
 
     if @message && @message.valid?
-      json_successful
+      json_successful(id: @message.id)
     else
       json_failed(REASON_INVALID_FIELD)
     end
diff --git a/app/controllers/semesters_controller.rb b/app/controllers/semesters_controller.rb
index 75d6099..41a7c13 100644
--- a/app/controllers/semesters_controller.rb
+++ b/app/controllers/semesters_controller.rb
@@ -15,8 +15,9 @@ class SemestersController < ApplicationController
   def create
     check_admin
 
-    if Semester.create(params.require(:semester).permit(:name))
-      json_successful
+    semester = Semester.create(params.require(:semester).permit(:name))
+    if semester
+        json_successful
     else
       json_failed
     end
diff --git a/app/controllers/student_comments_controller.rb b/app/controllers/student_comments_controller.rb
index 7ada2ac..647dc1f 100644
--- a/app/controllers/student_comments_controller.rb
+++ b/app/controllers/student_comments_controller.rb
@@ -12,8 +12,9 @@ class StudentCommentsController < ApplicationController
   # POST /lessons/1/students/1/comments.json
   def create
     if params[:lesson_id] && params[:student_id]
-      if StudentComment.create(
+      student_comment = StudentComment.create(
           params.require(:student_comment).permit(:content, :score).merge({lesson_id: params[:lesson_id], student_id: params[:student_id], creator_id: current_user.id}))
+      if student_comment && student_comment.valid?
         json_successful
       else
         json_failed
diff --git a/app/helpers/application_helper.rb b/app/helpers/application_helper.rb
index 9b5f3cf..e28c3bc 100644
--- a/app/helpers/application_helper.rb
+++ b/app/helpers/application_helper.rb
@@ -31,8 +31,8 @@ module ApplicationHelper
       end
     end
 
-    def json_successful
-      addition = {}
+    def json_successful(parameters = nil)
+      addition = parameters ? parameters.clone : {}
       if block_given?
         yield addition
       end
-- 
1.9.1

