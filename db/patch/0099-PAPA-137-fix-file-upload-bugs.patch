From ef0e67d56e293a4740d93339e3ba2d79d784e8f5 Mon Sep 17 00:00:00 2001
From: Alex Wang <ice_b0und@hotmail.com>
Date: Sat, 17 Oct 2015 17:44:42 +0800
Subject: [PATCH 099/150] PAPA-137 fix file upload bugs

---
 app/controllers/files_controller.rb       |  7 +++
 app/controllers/students_controller.rb    |  2 +-
 app/models/course.rb                      |  9 ++--
 test/controllers/files_controller_test.rb | 71 +++++++++++++++++++++++++++++++
 test/fixtures/course_files.yml            |  3 +-
 test/fixtures/lesson_files.yml            |  3 +-
 test/fixtures/student_files.yml           |  3 +-
 test/fixtures/teaching_courses.yml        |  4 ++
 test/fixtures/users.yml                   |  7 +++
 9 files changed, 98 insertions(+), 11 deletions(-)

diff --git a/app/controllers/files_controller.rb b/app/controllers/files_controller.rb
index d9e7483..5fc7b6a 100644
--- a/app/controllers/files_controller.rb
+++ b/app/controllers/files_controller.rb
@@ -68,10 +68,14 @@ class FilesController < ApplicationController
                   creator_id:       user.id
               )
             else
+              @file.destroy
               json_failed(REASON_PERMISSION_DENIED)
+              return
             end
           else
+            @file.destroy
             json_failed(REASON_PERMISSION_DENIED)
+            return
           end
         elsif params[:course_id]
           user = check_teacher
@@ -79,6 +83,7 @@ class FilesController < ApplicationController
           if course.teachers.include? user
             CourseFile.create(file_resource_id: @file.id, course_id: course.id)
           else
+            @file.destroy
             json_failed
             return
           end
@@ -88,9 +93,11 @@ class FilesController < ApplicationController
           json['id'] = @file.id
         end
       rescue ActiveRecord::RecordNotFound
+        @file.destroy
         json_failed
       end
     else
+      @file.destroy
       json_failed_invalid_fields(@file.errors.keys, file_type: :type, path: '', name: '')
     end
   end
diff --git a/app/controllers/students_controller.rb b/app/controllers/students_controller.rb
index 4202c6d..aed3c8f 100644
--- a/app/controllers/students_controller.rb
+++ b/app/controllers/students_controller.rb
@@ -30,7 +30,7 @@ class StudentsController < ApplicationController
   # POST /courses/1/students/1.json
   def create
     if params[:course_id] && params[:id]
-      if Course.find(params[:course_id]).students << User.find(params[:id])
+      if Participation.create(user_id: params[:id], course_id: params[:course_id], role: ROLE_STUDENT)
         json_successful
       else
         json_failed
diff --git a/app/models/course.rb b/app/models/course.rb
index a74f2d9..c90560e 100644
--- a/app/models/course.rb
+++ b/app/models/course.rb
@@ -6,7 +6,6 @@ class Course < ActiveRecord::Base
   has_many :lessons
 
   has_many :participations
-  has_many :participants, through: :participations, source: :user
 
   has_many :teaching_courses
   has_many :teachers, through: :teaching_courses, source: :user
@@ -18,15 +17,15 @@ class Course < ActiveRecord::Base
 
   def students
     users = User.none
-    participants.each do |p|
-      users <<= p if p.role == ROLE_STUDENT
+    participations.each do |p|
+      users <<= p.user if p.role == ROLE_STUDENT
     end
     users
   end
   def assistants
     users = User.none
-    participants.each do |p|
-      users <<= p if p.role == ROLE_ASSISTANT
+    participations.each do |p|
+      users <<= p.user if p.role == ROLE_ASSISTANT
     end
     users
   end
diff --git a/test/controllers/files_controller_test.rb b/test/controllers/files_controller_test.rb
index 99729cb..e950bf2 100644
--- a/test/controllers/files_controller_test.rb
+++ b/test/controllers/files_controller_test.rb
@@ -135,6 +135,77 @@ class FilesControllerTest < ActionController::TestCase
   end
 
   # POST /courses/1/files.json
+  test 'should add file to course by teacher' do
+    course = Course.first
+    teacher = course.teachers.first
+    sign_in teacher
+
+    fixture_file = fixture_file_upload('files/2.jpg', 'image/jpeg')
+
+    assert_difference %w"FileResource.count CourseFile.count" do
+      post :create, format: :json, course_id: course.id, file: {file: fixture_file, type: 'picture'}
+    end
+
+    assert_json_success
+    assert_not_nil assigns(:file).path
+    assert json['id']
+  end
+
+  # POST /courses/1/files.json
+  test 'should not add file to course by teacher from another course' do
+    course = Course.find_by_name('Data Structures')
+    teacher = User.find_by_name('ciara')
+    sign_in teacher
+
+    fixture_file = fixture_file_upload('files/2.jpg', 'image/jpeg')
+
+    assert_no_difference 'FileResource.count' do
+      post :create, format: :json, course_id: course.id, file: { file: fixture_file, type: 'picture' }
+    end
+
+    assert STATUS_FAIL, json['status']
+  end
+
+  # POST /students/1/lessons/1/files.json
+  test 'should add file to a student on the lesson by himself' do
+    lesson = Lesson.first
+    student = lesson.course.students.first
+    token = student.create_token.token
+
+    fixture_file = fixture_file_upload('files/2.jpg', 'image/jpeg')
+
+    assert_difference %w"FileResource.count StudentFile.count" do
+      post :create, format: :json,
+           token: token,
+           student_id: student.id,
+           lesson_id: lesson.id,
+           file: {file: fixture_file, type: 'picture'}
+    end
+
+    assert_json_success
+    assert_not_nil assigns(:file).path
+    assert json['id']
+  end
+
+  # POST /students/1/lessons/1/files.json
+  test 'should not add a file to a student by another student' do
+    course = Course.find_by_name('Operation System')
+    lesson = course.lessons.first
+    student = course.students.first
+    token = User.find_by_name('ciara').create_token.token
+
+    fixture_file = fixture_file_upload('files/2.jpg', 'image/jpeg')
+
+    assert_no_difference %w"FileResource.count StudentFile.count" do
+      post :create, format: :json,
+           token: token,
+           student_id: student.id,
+           lesson_id: lesson.id,
+           file: {file: fixture_file, type: 'picture'}
+    end
+
+    assert STATUS_FAIL, json['status']
+  end
 
   # DELETE /files/1.json
   test 'should delete file if he is the creator' do
diff --git a/test/fixtures/course_files.yml b/test/fixtures/course_files.yml
index 4677a20..b7822ac 100644
--- a/test/fixtures/course_files.yml
+++ b/test/fixtures/course_files.yml
@@ -1,4 +1,3 @@
 os_file:
   course: os
-  file_resource: pdf_file
-  creator: alex
\ No newline at end of file
+  file_resource: pdf_file
\ No newline at end of file
diff --git a/test/fixtures/lesson_files.yml b/test/fixtures/lesson_files.yml
index 2e5d44a..68b20af 100644
--- a/test/fixtures/lesson_files.yml
+++ b/test/fixtures/lesson_files.yml
@@ -1,4 +1,3 @@
 exp1_file1:
   lesson: exp1
-  file_resource: pdf_file
-  creator: alex
\ No newline at end of file
+  file_resource: pdf_file
\ No newline at end of file
diff --git a/test/fixtures/student_files.yml b/test/fixtures/student_files.yml
index b0a8622..7afbfc3 100644
--- a/test/fixtures/student_files.yml
+++ b/test/fixtures/student_files.yml
@@ -1,4 +1,5 @@
 betty_file:
   student: betty
   file_resource: pdf
-  lesson: exp1
\ No newline at end of file
+  lesson: exp1
+  creator: alex
\ No newline at end of file
diff --git a/test/fixtures/teaching_courses.yml b/test/fixtures/teaching_courses.yml
index d32a3b9..89bbac0 100644
--- a/test/fixtures/teaching_courses.yml
+++ b/test/fixtures/teaching_courses.yml
@@ -9,3 +9,7 @@ alex_teaches_ds:
 ciara_teaches_cpp:
   user: ciara
   course: cpp
+
+deng_teaches_ds:
+  user: deng
+  course: ds
\ No newline at end of file
diff --git a/test/fixtures/users.yml b/test/fixtures/users.yml
index a520539..6a08443 100644
--- a/test/fixtures/users.yml
+++ b/test/fixtures/users.yml
@@ -18,4 +18,11 @@ ciara:
   phone: '121'
   email: 'ciara@b.c'
   encrypted_password: <%= User.new.send(:password_digest, '123') %>
+  is_teacher: true
+
+deng:
+  name: 'deng'
+  phone: '1234'
+  email: 'deng@b.c'
+  encrypted_password: <%= User.new.send(:password_digest, '123') %>
   is_teacher: true
\ No newline at end of file
-- 
1.9.1

